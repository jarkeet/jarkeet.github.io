<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ActivityThread,AMS," />










<meta name="description" content="基于Android 6.0的源码剖析， 分析android Activity启动流程，相关源码：  1234567891011121314151617frameworks/base/services/core/java/com/android/server/am/  - ActivityManagerService.java  - ActivityStackSupervisor.java  -">
<meta name="keywords" content="ActivityThread,AMS">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity启动分析">
<meta property="og:url" content="http://yoursite.com/2018/03/14/Activity启动分析/index.html">
<meta property="og:site_name" content="Write something">
<meta property="og:description" content="基于Android 6.0的源码剖析， 分析android Activity启动流程，相关源码：  1234567891011121314151617frameworks/base/services/core/java/com/android/server/am/  - ActivityManagerService.java  - ActivityStackSupervisor.java  -">
<meta property="og:image" content="http://gityuan.com/images/activity/start_activity.jpg">
<meta property="og:image" content="http://gityuan.com/images/activity/start_activity_process.jpg">
<meta property="og:updated_time" content="2018-03-23T03:23:10.680Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity启动分析">
<meta name="twitter:description" content="基于Android 6.0的源码剖析， 分析android Activity启动流程，相关源码：  1234567891011121314151617frameworks/base/services/core/java/com/android/server/am/  - ActivityManagerService.java  - ActivityStackSupervisor.java  -">
<meta name="twitter:image" content="http://gityuan.com/images/activity/start_activity.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'GB10AN7BSS',
      apiKey: 'd96e100af839e1d1e7116c114785f5b9',
      indexName: 'algolia_index',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/03/14/Activity启动分析/"/>





  <title>Activity启动分析 | Write something</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Write something</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/14/Activity启动分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="jarkeet">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Write something">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Activity启动分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-14T13:40:00+08:00">
                2018-03-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android开发艺术探索/" itemprop="url" rel="index">
                    <span itemprop="name">Android开发艺术探索</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>基于Android 6.0的源码剖析， 分析android Activity启动流程，相关源码：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">frameworks/base/services/core/java/com/android/server/am/</div><div class="line">  - ActivityManagerService.java</div><div class="line">  - ActivityStackSupervisor.java</div><div class="line">  - ActivityStack.java</div><div class="line">  - ActivityRecord.java</div><div class="line">  - ProcessRecord.java</div><div class="line"></div><div class="line">frameworks/base/core/java/android/app/</div><div class="line">  - IActivityManager.java</div><div class="line">  - ActivityManagerNative.java (内含AMP)</div><div class="line">  - ActivityManager.java</div><div class="line">  </div><div class="line">  - IApplicationThread.java</div><div class="line">  - ApplicationThreadNative.java (内含ATP)</div><div class="line">  - ActivityThread.java (内含ApplicationThread)</div><div class="line">  </div><div class="line">  - ContextImpl.java</div></pre></td></tr></table></figure>
<h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一. 概述"></a>一. 概述</h2><p><code>startActivity</code>的整体流程与<a href="http://gityuan.com/2016/03/06/start-service/" target="_blank" rel="external">startService启动过程分析</a>非常相近，但比Service启动更为复杂，多了stack/task以及UI的相关内容以及Activity的生命周期更为丰富。</p>
<p>Activity启动发起后，通过Binder最终交由system进程中的AMS来完成，则启动流程如下图：</p>
<p><img src="http://gityuan.com/images/activity/start_activity.jpg" alt="start_activity"></p>
<p>接下来，从源码来说说每个过程。</p>
<a id="more"></a>
<h2 id="二-启动流程"><a href="#二-启动流程" class="headerlink" title="二. 启动流程"></a>二. 启动流程</h2><h3 id="2-1-Activity-startActivity"><a href="#2-1-Activity-startActivity" class="headerlink" title="2.1 Activity.startActivity"></a>2.1 Activity.startActivity</h3><p>[-&gt; Activity.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">        startActivityForResult(intent, -<span class="number">1</span>, options);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//[见小节2.2]</span></div><div class="line">        startActivityForResult(intent, -<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-2-startActivityForResult"><a href="#2-2-startActivityForResult" class="headerlink" title="2.2 startActivityForResult"></a>2.2 startActivityForResult</h3><p>[-&gt; Activity.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode)</span> </span>&#123;</div><div class="line">    startActivityForResult(intent, requestCode, <span class="keyword">null</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//[见小节2.3]</span></div><div class="line">        Instrumentation.ActivityResult ar =</div><div class="line">            mInstrumentation.execStartActivity(</div><div class="line">                <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</div><div class="line">                intent, requestCode, options);</div><div class="line">        <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</div><div class="line">            mMainThread.sendActivityResult(</div><div class="line">                mToken, mEmbeddedID, requestCode, ar.getResultCode(),</div><div class="line">                ar.getResultData());</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//此时requestCode =-1</span></div><div class="line">        <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</div><div class="line">            mStartedActivity = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        cancelInputsAndStartExitTransition(options);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>execStartActivity()方法的参数:</p>
<ul>
<li><code>mAppThread</code>: 数据类型为ApplicationThread，通过mMainThread.getApplicationThread()方法获取。</li>
<li><code>mToken</code>: 数据类型为IBinder.</li>
</ul>
<h3 id="2-3-execStartActivity"><a href="#2-3-execStartActivity" class="headerlink" title="2.3 execStartActivity"></a>2.3 execStartActivity</h3><p>[-&gt; Instrumentation.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">( Context who, IBinder contextThread, IBinder token, Activity target, Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</div><div class="line"></div><div class="line">    IApplicationThread whoThread = (IApplicationThread) contextThread;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">synchronized</span> (mSync) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</div><div class="line">                <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</div><div class="line">                <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</div><div class="line">                    am.mHits++;</div><div class="line">                    <span class="comment">//当该monitor阻塞activity启动,则直接返回</span></div><div class="line">                    <span class="keyword">if</span> (am.isBlocking()) &#123;</div><div class="line">                        <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        intent.migrateExtraStreamToClipData();</div><div class="line">        intent.prepareToLeaveProcess();</div><div class="line">        <span class="comment">//[见小节2.4]</span></div><div class="line">        <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</div><div class="line">            .startActivity(whoThread, who.getBasePackageName(), intent,</div><div class="line">                    intent.resolveTypeIfNeeded(who.getContentResolver()),</div><div class="line">                    token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</div><div class="line">                    requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</div><div class="line">        <span class="comment">//检查activity是否启动成功</span></div><div class="line">        checkStartActivityResult(result, intent);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>关于 ActivityManagerNative.getDefault()返回的是ActivityManagerProxy对象(跨进程返回Stub.Proxy对象).</strong> 此处startActivity()的共有10个参数, 下面说说每个参数传递AMP.startActivity()每一项的对应值:</p>
<ul>
<li>caller: 当前应用的ApplicationThread对象mAppThread;</li>
<li>callingPackage: 调用当前ContextImpl.getBasePackageName(),获取当前Activity所在包名;</li>
<li>intent: 这便是启动Activity时,传递过来的参数;</li>
<li>resolvedType: 调用intent.resolveTypeIfNeeded而获取;</li>
<li>resultTo: 来自于当前Activity.mToken</li>
<li>resultWho: 来自于当前Activity.mEmbeddedID</li>
<li>requestCode = -1;</li>
<li>startFlags = 0;</li>
<li>profilerInfo = null;</li>
<li>options = null;</li>
</ul>
<h3 id="2-4-AMP-startActivity"><a href="#2-4-AMP-startActivity" class="headerlink" title="2.4 AMP.startActivity"></a>2.4 AMP.startActivity</h3><p>[-&gt; ActivityManagerNative.java :: ActivityManagerProxy]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ActivityManagerProxy</span> <span class="keyword">implements</span> <span class="title">IActivityManager</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        Parcel data = Parcel.obtain();</div><div class="line">        Parcel reply = Parcel.obtain();</div><div class="line">        data.writeInterfaceToken(IActivityManager.descriptor);</div><div class="line">        data.writeStrongBinder(caller != <span class="keyword">null</span> ? caller.asBinder() : <span class="keyword">null</span>);</div><div class="line">        data.writeString(callingPackage);</div><div class="line">        intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">        data.writeString(resolvedType);</div><div class="line">        data.writeStrongBinder(resultTo);</div><div class="line">        data.writeString(resultWho);</div><div class="line">        data.writeInt(requestCode);</div><div class="line">        data.writeInt(startFlags);</div><div class="line">        <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            data.writeInt(<span class="number">1</span>);</div><div class="line">            profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            data.writeInt(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</div><div class="line">            data.writeInt(<span class="number">1</span>);</div><div class="line">            options.writeToParcel(data, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            data.writeInt(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//[见流程2.5]</span></div><div class="line">        mRemote.transact(START_ACTIVITY_TRANSACTION, data, reply, <span class="number">0</span>);</div><div class="line">        reply.readException();</div><div class="line">        <span class="keyword">int</span> result = reply.readInt();</div><div class="line">        reply.recycle();</div><div class="line">        data.recycle();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>AMP经过binder IPC,进入ActivityManagerNative(简称AMN)。<strong>接下来程序进入了system_sever进程</strong>，开始继续执行。</p>
<h3 id="2-5-AMN-onTransact"><a href="#2-5-AMN-onTransact" class="headerlink" title="2.5 AMN.onTransact"></a>2.5 AMN.onTransact</h3><p>[-&gt; ActivityManagerNative.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">    <span class="keyword">case</span> START_ACTIVITY_TRANSACTION:</div><div class="line">    &#123;</div><div class="line">      data.enforceInterface(IActivityManager.descriptor);</div><div class="line">      IBinder b = data.readStrongBinder();</div><div class="line">      IApplicationThread app = ApplicationThreadNative.asInterface(b);</div><div class="line">      String callingPackage = data.readString();</div><div class="line">      Intent intent = Intent.CREATOR.createFromParcel(data);</div><div class="line">      String resolvedType = data.readString();</div><div class="line">      IBinder resultTo = data.readStrongBinder();</div><div class="line">      String resultWho = data.readString();</div><div class="line">      <span class="keyword">int</span> requestCode = data.readInt();</div><div class="line">      <span class="keyword">int</span> startFlags = data.readInt();</div><div class="line">      ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></div><div class="line">              ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</div><div class="line">      Bundle options = data.readInt() != <span class="number">0</span></div><div class="line">              ? Bundle.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</div><div class="line">      <span class="comment">//[见流程2.6]</span></div><div class="line">      <span class="keyword">int</span> result = startActivity(app, callingPackage, intent, resolvedType,</div><div class="line">              resultTo, resultWho, requestCode, startFlags, profilerInfo, options);</div><div class="line">      reply.writeNoException();</div><div class="line">      reply.writeInt(result);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    &#125;    &#125;</div></pre></td></tr></table></figure>
<h3 id="2-6-AMS-startActivity"><a href="#2-6-AMS-startActivity" class="headerlink" title="2.6 AMS.startActivity"></a>2.6 AMS.startActivity</h3><p>[-&gt; ActivityManagerService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</div><div class="line">        resultWho, requestCode, startFlags, profilerInfo, options,</div><div class="line">        UserHandle.getCallingUserId());</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage, Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line">    enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</div><div class="line">    userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</div><div class="line">            <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">//[见小节2.7]</span></div><div class="line">    <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</div><div class="line">            resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</div><div class="line">            profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>此处mStackSupervisor的数据类型为<code>ActivityStackSupervisor</code></p>
<h3 id="2-7-ASS-startActivityMayWait"><a href="#2-7-ASS-startActivityMayWait" class="headerlink" title="2.7 ASS.startActivityMayWait"></a>2.7 ASS.startActivityMayWait</h3><p>当程序运行到这里时, ASS.startActivityMayWait的各个参数取值如下:</p>
<ul>
<li>caller = ApplicationThreadProxy, 用于跟调用者进程ApplicationThread进行通信的binder代理类.</li>
<li>callingUid = -1;</li>
<li>callingPackage = ContextImpl.getBasePackageName(),获取调用者Activity所在包名</li>
<li>intent: 这是启动Activity时传递过来的参数;</li>
<li>resolvedType = intent.resolveTypeIfNeeded</li>
<li>voiceSession = null;</li>
<li>voiceInteractor = null;</li>
<li>resultTo = Activity.mToken, 其中Activity是指调用者所在Activity, mToken对象保存自己所处的ActivityRecord信息</li>
<li>resultWho = Activity.mEmbeddedID, 其中Activity是指调用者所在Activity</li>
<li>requestCode = -1;</li>
<li>startFlags = 0;</li>
<li>profilerInfo = null;</li>
<li>outResult = null;</li>
<li>config = null;</li>
<li>options = null;</li>
<li>ignoreTargetSecurity = false;</li>
<li>userId = AMS.handleIncomingUser, 当调用者userId跟当前处于同一个userId,则直接返回该userId;当不相等时则根据调用者userId来决定是否需要将callingUserId转换为mCurrentUserId.</li>
<li>iContainer = null;</li>
<li>inTask = null;</li>
</ul>
<p>再来看看这个方法的源码:</p>
<p>[-&gt; ActivityStackSupervisor.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityMayWait</span><span class="params">(IApplicationThread caller, <span class="keyword">int</span> callingUid, String callingPackage, Intent intent, String resolvedType, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, WaitResult outResult, Configuration config, Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">int</span> userId, IActivityContainer iContainer, TaskRecord inTask)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">boolean</span> componentSpecified = intent.getComponent() != <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//创建新的Intent对象，即便intent被修改也不受影响</span></div><div class="line">    intent = <span class="keyword">new</span> Intent(intent);</div><div class="line"></div><div class="line">    <span class="comment">//收集Intent所指向的Activity信息, 当存在多个可供选择的Activity,则直接向用户弹出resolveActivity [见2.7.1]</span></div><div class="line">    ActivityInfo aInfo = resolveActivity(intent, resolvedType, startFlags, profilerInfo, userId);</div><div class="line"></div><div class="line">    ActivityContainer container = (ActivityContainer)iContainer;</div><div class="line">    <span class="keyword">synchronized</span> (mService) &#123;</div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span> &amp;&amp; container.mParentActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                container.mParentActivity.state != RESUMED) &#123;</div><div class="line">            ... <span class="comment">//不进入该分支, container == nul</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> realCallingPid = Binder.getCallingPid();</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> realCallingUid = Binder.getCallingUid();</div><div class="line">        <span class="keyword">int</span> callingPid;</div><div class="line">        <span class="keyword">if</span> (callingUid &gt;= <span class="number">0</span>) &#123;</div><div class="line">            callingPid = -<span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (caller == <span class="keyword">null</span>) &#123;</div><div class="line">            callingPid = realCallingPid;</div><div class="line">            callingUid = realCallingUid;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            callingPid = callingUid = -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> ActivityStack stack;</div><div class="line">        <span class="keyword">if</span> (container == <span class="keyword">null</span> || container.mStack.isOnHomeDisplay()) &#123;</div><div class="line">            stack = mFocusedStack; <span class="comment">// 进入该分支</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            stack = container.mStack;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//此时mConfigWillChange = false</span></div><div class="line">        stack.mConfigWillChange = config != <span class="keyword">null</span> &amp;&amp; mService.mConfiguration.diff(config) != <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> origId = Binder.clearCallingIdentity();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (aInfo != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                (aInfo.applicationInfo.privateFlags</div><div class="line">                        &amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// heavy-weight进程处理流程, 一般情况下不进入该分支</span></div><div class="line">            <span class="keyword">if</span> (aInfo.processName.equals(aInfo.applicationInfo.packageName)) &#123;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//[见流程2.8]</span></div><div class="line">        <span class="keyword">int</span> res = startActivityLocked(caller, intent, resolvedType, aInfo,</div><div class="line">                voiceSession, voiceInteractor, resultTo, resultWho,</div><div class="line">                requestCode, callingPid, callingUid, callingPackage,</div><div class="line">                realCallingPid, realCallingUid, startFlags, options, ignoreTargetSecurity,</div><div class="line">                componentSpecified, <span class="keyword">null</span>, container, inTask);</div><div class="line"></div><div class="line">        Binder.restoreCallingIdentity(origId);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (stack.mConfigWillChange) &#123;</div><div class="line">            ... <span class="comment">//不进入该分支</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (outResult != <span class="keyword">null</span>) &#123;</div><div class="line">            ... <span class="comment">//不进入该分支</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>该过程主要功能：通过resolveActivity来获取ActivityInfo信息, 然后再进入ASS.startActivityLocked().先来看看</p>
<h4 id="2-7-1-ASS-resolveActivity"><a href="#2-7-1-ASS-resolveActivity" class="headerlink" title="2.7.1 ASS.resolveActivity"></a>2.7.1 ASS.resolveActivity</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// startFlags = 0; profilerInfo = null; userId代表caller UserId</span></div><div class="line"><span class="function">ActivityInfo <span class="title">resolveActivity</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line">    ActivityInfo aInfo;</div><div class="line">    ResolveInfo rInfo =</div><div class="line">        AppGlobals.getPackageManager().resolveIntent(</div><div class="line">                intent, resolvedType,</div><div class="line">                PackageManager.MATCH_DEFAULT_ONLY</div><div class="line">                            | ActivityManagerService.STOCK_PM_FLAGS, userId);</div><div class="line">    aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (aInfo != <span class="keyword">null</span>) &#123;</div><div class="line">        intent.setComponent(<span class="keyword">new</span> ComponentName(</div><div class="line">                aInfo.applicationInfo.packageName, aInfo.name));</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!aInfo.processName.equals(<span class="string">"system"</span>)) &#123;</div><div class="line">            ... <span class="comment">//对于非system进程，根据flags来设置相应的debug信息</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> aInfo;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ActivityManager类有如下4个flags用于调试：</p>
<ul>
<li>START_FLAG_DEBUG：用于调试debug app</li>
<li>START_FLAG_OPENGL_TRACES：用于调试OpenGL tracing</li>
<li>START_FLAG_NATIVE_DEBUGGING：用于调试native</li>
<li>START_FLAG_TRACK_ALLOCATION: 用于调试allocation tracking</li>
</ul>
<h4 id="2-7-2-PKMS-resolveIntent"><a href="#2-7-2-PKMS-resolveIntent" class="headerlink" title="2.7.2 PKMS.resolveIntent"></a>2.7.2 PKMS.resolveIntent</h4><p>AppGlobals.getPackageManager()经过函数层层调用，获取的是ApplicationPackageManager对象。经过binder IPC调用，最终会调用PackageManagerService对象。故此时调用方法为PMS.resolveIntent().</p>
<p>[-&gt; PackageManagerService.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ResolveInfo <span class="title">resolveIntent</span><span class="params">(Intent intent, String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">     enforceCrossUserPermission(Binder.getCallingUid(), userId, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="string">"resolve intent"</span>);</div><div class="line">     <span class="comment">//[见流程2.7.3]</span></div><div class="line">     List&lt;ResolveInfo&gt; query = queryIntentActivities(intent, resolvedType, flags, userId);</div><div class="line">     <span class="comment">//根据priority，preferred选择最佳的Activity</span></div><div class="line">     <span class="keyword">return</span> chooseBestActivity(intent, resolvedType, flags, query, userId);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h4 id="2-7-3-PMS-queryIntentActivities"><a href="#2-7-3-PMS-queryIntentActivities" class="headerlink" title="2.7.3 PMS.queryIntentActivities"></a>2.7.3 PMS.queryIntentActivities</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentActivities</span><span class="params">(Intent intent,</span></span></div><div class="line">        String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId) &#123;</div><div class="line">    ...</div><div class="line">    ComponentName comp = intent.getComponent();</div><div class="line">    <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (intent.getSelector() != <span class="keyword">null</span>) &#123;</div><div class="line">            intent = intent.getSelector();</div><div class="line">            comp = intent.getComponent();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (comp != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> List&lt;ResolveInfo&gt; list = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</div><div class="line">        <span class="comment">//获取Activity信息</span></div><div class="line">        <span class="keyword">final</span> ActivityInfo ai = getActivityInfo(comp, flags, userId);</div><div class="line">        <span class="keyword">if</span> (ai != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">final</span> ResolveInfo ri = <span class="keyword">new</span> ResolveInfo();</div><div class="line">            ri.activityInfo = ai;</div><div class="line">            list.add(ri);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> list;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ASS.resolveActivity()方法的核心功能是找到相应的Activity组件，并保存到intent对象。</p>
<h3 id="2-8-ASS-startActivityLocked"><a href="#2-8-ASS-startActivityLocked" class="headerlink" title="2.8 ASS.startActivityLocked"></a>2.8 ASS.startActivityLocked</h3><p>[-&gt; ActivityStackSupervisor.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityLocked</span><span class="params">(IApplicationThread caller, Intent intent, String resolvedType, ActivityInfo aInfo, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String callingPackage, <span class="keyword">int</span> realCallingPid, <span class="keyword">int</span> realCallingUid, <span class="keyword">int</span> startFlags, Bundle options, <span class="keyword">boolean</span> ignoreTargetSecurity, <span class="keyword">boolean</span> componentSpecified, ActivityRecord[] outActivity, ActivityContainer container, TaskRecord inTask)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> err = ActivityManager.START_SUCCESS;</div><div class="line"></div><div class="line">    <span class="comment">//获取调用者的进程记录对象</span></div><div class="line">    ProcessRecord callerApp = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (caller != <span class="keyword">null</span>) &#123;</div><div class="line">        callerApp = mService.getRecordForAppLocked(caller);</div><div class="line">        <span class="keyword">if</span> (callerApp != <span class="keyword">null</span>) &#123;</div><div class="line">            callingPid = callerApp.pid;</div><div class="line">            callingUid = callerApp.info.uid;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            err = ActivityManager.START_PERMISSION_DENIED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> userId = aInfo != <span class="keyword">null</span> ?  UserHandle.getUserId(aInfo.applicationInfo.uid) : <span class="number">0</span>;</div><div class="line"></div><div class="line">    ActivityRecord sourceRecord = <span class="keyword">null</span>;</div><div class="line">    ActivityRecord resultRecord = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (resultTo != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//获取调用者所在的Activity</span></div><div class="line">        sourceRecord = isInAnyStackLocked(resultTo);</div><div class="line">        <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span> &amp;&amp; !sourceRecord.finishing) &#123;</div><div class="line">                ... <span class="comment">//requestCode = -1 则不进入</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_FORWARD_RESULT) != <span class="number">0</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        ... <span class="comment">// activity执行结果的返回由源Activity转换到新Activity, 不需要返回结果则不会进入该分支</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; intent.getComponent() == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//从Intent中无法找到相应的Component</span></div><div class="line">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS &amp;&amp; aInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//从Intent中无法找到相应的ActivityInfo</span></div><div class="line">        err = ActivityManager.START_INTENT_NOT_RESOLVED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err == ActivityManager.START_SUCCESS</div><div class="line">            &amp;&amp; !isCurrentProfileLocked(userId)</div><div class="line">            &amp;&amp; (aInfo.flags &amp; FLAG_SHOW_FOR_ALL_USERS) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//尝试启动一个后台Activity, 但该Activity对当前用户不可见</span></div><div class="line">        err = ActivityManager.START_NOT_CURRENT_USER_ACTIVITY;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="comment">//执行后resultStack = null</span></div><div class="line">    <span class="keyword">final</span> ActivityStack resultStack = resultRecord == <span class="keyword">null</span> ? <span class="keyword">null</span> : resultRecord.task.stack;</div><div class="line"></div><div class="line">    ... <span class="comment">//权限检查</span></div><div class="line"></div><div class="line">    <span class="comment">// ActivityController不为空的情况，比如monkey测试过程</span></div><div class="line">    <span class="keyword">if</span> (mService.mController != <span class="keyword">null</span>) &#123;</div><div class="line">        Intent watchIntent = intent.cloneFilter();</div><div class="line">        abort |= !mService.mController.activityStarting(watchIntent,</div><div class="line">                aInfo.applicationInfo.packageName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (abort) &#123;</div><div class="line">        ... <span class="comment">//权限检查不满足,才进入该分支则直接返回；</span></div><div class="line">        <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 创建Activity记录对象</span></div><div class="line">    ActivityRecord r = <span class="keyword">new</span> ActivityRecord(mService, callerApp, callingUid, callingPackage,</div><div class="line">            intent, resolvedType, aInfo, mService.mConfiguration, resultRecord, resultWho,</div><div class="line">            requestCode, componentSpecified, voiceSession != <span class="keyword">null</span>, <span class="keyword">this</span>, container, options);</div><div class="line">    <span class="keyword">if</span> (outActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        outActivity[<span class="number">0</span>] = r;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.appTimeTracker == <span class="keyword">null</span> &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        r.appTimeTracker = sourceRecord.appTimeTracker;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 将mFocusedStack赋予当前stack</span></div><div class="line">    <span class="keyword">final</span> ActivityStack stack = mFocusedStack;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (voiceSession == <span class="keyword">null</span> &amp;&amp; (stack.mResumedActivity == <span class="keyword">null</span></div><div class="line">            || stack.mResumedActivity.info.applicationInfo.uid != callingUid)) &#123;</div><div class="line">        <span class="comment">// 前台stack还没有resume状态的Activity时, 则检查app切换是否允许 [见流程2.8.1]</span></div><div class="line">        <span class="keyword">if</span> (!mService.checkAppSwitchAllowedLocked(callingPid, callingUid,</div><div class="line">                realCallingPid, realCallingUid, <span class="string">"Activity start"</span>)) &#123;</div><div class="line">            PendingActivityLaunch pal =</div><div class="line">                    <span class="keyword">new</span> PendingActivityLaunch(r, sourceRecord, startFlags, stack);</div><div class="line">            <span class="comment">// 当不允许切换,则把要启动的Activity添加到mPendingActivityLaunches对象, 并且直接返回.</span></div><div class="line">            mPendingActivityLaunches.add(pal);</div><div class="line">            ActivityOptions.abort(options);</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_SWITCHES_CANCELED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.mDidAppSwitch) &#123;</div><div class="line">        <span class="comment">//从上次禁止app切换以来,这是第二次允许app切换,因此将允许切换时间设置为0,则表示可以任意切换app</span></div><div class="line">        mService.mAppSwitchesAllowedTime = <span class="number">0</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mService.mDidAppSwitch = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//处理 pendind Activity的启动, 这些Activity是由于app switch禁用从而被hold的等待启动activity [见流程2.8.2]</span></div><div class="line">    doPendingActivityLaunchesLocked(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">    <span class="comment">//[见流程2.9]</span></div><div class="line">    err = startActivityUncheckedLocked(r, sourceRecord, voiceSession, voiceInteractor,</div><div class="line">            startFlags, <span class="keyword">true</span>, options, inTask);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (err &lt; <span class="number">0</span>) &#123;</div><div class="line">        notifyActivityDrawnForKeyguard();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> err;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中有两个返回值代表启动Activity失败：</p>
<ul>
<li>START_INTENT_NOT_RESOLVED: 从Intent中无法找到相应的Component或者ActivityInfo</li>
<li>START_NOT_CURRENT_USER_ACTIVITY：该Activity对当前用户不可见</li>
</ul>
<h4 id="2-8-1-AMS-checkAppSwitchAllowedLocked"><a href="#2-8-1-AMS-checkAppSwitchAllowedLocked" class="headerlink" title="2.8.1 AMS.checkAppSwitchAllowedLocked"></a>2.8.1 AMS.checkAppSwitchAllowedLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">checkAppSwitchAllowedLocked</span><span class="params">(<span class="keyword">int</span> sourcePid, <span class="keyword">int</span> sourceUid, <span class="keyword">int</span> callingPid, <span class="keyword">int</span> callingUid, String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mAppSwitchesAllowedTime &lt; SystemClock.uptimeMillis()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> perm = checkComponentPermission(</div><div class="line">            android.Manifest.permission.STOP_APP_SWITCHES, sourcePid,</div><div class="line">            sourceUid, -<span class="number">1</span>, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">if</span> (perm == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (callingUid != -<span class="number">1</span> &amp;&amp; callingUid != sourceUid) &#123;</div><div class="line">        perm = checkComponentPermission(</div><div class="line">                android.Manifest.permission.STOP_APP_SWITCHES, callingPid,</div><div class="line">                callingUid, -<span class="number">1</span>, <span class="keyword">true</span>);</div><div class="line">        <span class="keyword">if</span> (perm == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当mAppSwitchesAllowedTime时间小于当前时长,或者具有STOP_APP_SWITCHES的权限,则允许app发生切换操作.</p>
<p>其中mAppSwitchesAllowedTime, 在<code>AMS.stopAppSwitches()</code>的过程中会设置为:<code>mAppSwitchesAllowedTime = SystemClock.uptimeMillis() + APP_SWITCH_DELAY_TIME</code>. 禁止app切换的timeout时长为5s(APP_SWITCH_DELAY_TIME = 5s).</p>
<p>当发送5秒超时或者执行<code>AMS.resumeAppSwitches()</code>过程会将mAppSwitchesAllowedTime设置0, 都会开启允许app执行切换的操作.另外,禁止App切换的操作,对于同一个app是不受影响的,有兴趣可以进一步查看<code>checkComponentPermission</code>过程.</p>
<h4 id="2-8-2-ASS-doPendingActivityLaunchesLocked"><a href="#2-8-2-ASS-doPendingActivityLaunchesLocked" class="headerlink" title="2.8.2 ASS.doPendingActivityLaunchesLocked"></a>2.8.2 ASS.doPendingActivityLaunchesLocked</h4><p>[-&gt; ActivityStackSupervisor.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">doPendingActivityLaunchesLocked</span><span class="params">(<span class="keyword">boolean</span> doResume)</span> </span>&#123;</div><div class="line">    <span class="keyword">while</span> (!mPendingActivityLaunches.isEmpty()) &#123;</div><div class="line">        PendingActivityLaunch pal = mPendingActivityLaunches.remove(<span class="number">0</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//[见流程2.9]</span></div><div class="line">            startActivityUncheckedLocked(pal.r, pal.sourceRecord, <span class="keyword">null</span>, <span class="keyword">null</span>, pal.startFlags,</div><div class="line">                                         doResume &amp;&amp; mPendingActivityLaunches.isEmpty(), <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>mPendingActivityLaunches</code>记录着所有将要启动的Activity, 是由于在<code>startActivityLocked</code>的过程时App切换功能被禁止, 也就是不运行切换Activity, 那么此时便会把相应的Activity加入到<code>mPendingActivityLaunches</code>队列. 该队列的成员在执行完<code>doPendingActivityLaunchesLocked</code>便会清空.</p>
<p>启动mPendingActivityLaunches中所有的Activity, 由于doResume = false, 那么这些activtity并不会进入resume状态,而是设置delayedResume = true, 会延迟resume.</p>
<h3 id="2-9-ASS-startActivityUncheckedLocked"><a href="#2-9-ASS-startActivityUncheckedLocked" class="headerlink" title="2.9 ASS.startActivityUncheckedLocked"></a>2.9 ASS.startActivityUncheckedLocked</h3><p>[-&gt; ActivityStackSupervisor.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// sourceRecord是指调用者， r是指本次将要启动的Activity</span></div><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityUncheckedLocked</span><span class="params">(<span class="keyword">final</span> ActivityRecord r, ActivityRecord sourceRecord, IVoiceInteractionSession voiceSession, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> startFlags, <span class="keyword">boolean</span> doResume, Bundle options, TaskRecord inTask)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> Intent intent = r.intent;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callingUid = r.launchedFromUid;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (inTask != <span class="keyword">null</span> &amp;&amp; !inTask.inRecents) &#123;</div><div class="line">        inTask = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTop = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TOP;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleInstance = r.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchSingleTask = r.launchMode == ActivityInfo.LAUNCH_SINGLE_TASK;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> launchFlags = intent.getFlags();</div><div class="line">    <span class="comment">// 当intent和activity manifest存在冲突，则manifest优先</span></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp;</div><div class="line">            (launchSingleInstance || launchSingleTask)) &#123;</div><div class="line">        launchFlags &amp;=</div><div class="line">                ~(Intent.FLAG_ACTIVITY_NEW_DOCUMENT | Intent.FLAG_ACTIVITY_MULTIPLE_TASK);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> launchTaskBehind = r.mLaunchTaskBehind</div><div class="line">            &amp;&amp; !launchSingleTask &amp;&amp; !launchSingleInstance</div><div class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span></div><div class="line">            &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">        r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>,</div><div class="line">                r.resultTo, r.resultWho, r.requestCode,</div><div class="line">                Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        r.resultTo = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_DOCUMENT) != <span class="number">0</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">        launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (launchTaskBehind</div><div class="line">                || r.info.documentLaunchMode == ActivityInfo.DOCUMENT_LAUNCH_ALWAYS) &#123;</div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_MULTIPLE_TASK;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mUserLeaving = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_USER_ACTION) == <span class="number">0</span>;</div><div class="line">    <span class="comment">//当本次不需要resume，则设置为延迟resume的状态</span></div><div class="line">    <span class="keyword">if</span> (!doResume) &#123;</div><div class="line">        r.delayedResume = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityRecord notTop =</div><div class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_PREVIOUS_IS_TOP) != <span class="number">0</span> ? r : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">        ActivityRecord checkedCaller = sourceRecord;</div><div class="line">        <span class="keyword">if</span> (checkedCaller == <span class="keyword">null</span>) &#123;</div><div class="line">            checkedCaller = mFocusedStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!checkedCaller.realActivity.equals(r.realActivity)) &#123;</div><div class="line">            <span class="comment">//调用者 与将要启动的Activity不相同时，进入该分支。</span></div><div class="line">            startFlags &amp;= ~ActivityManager.START_FLAG_ONLY_IF_NEEDED;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> addingToTask = <span class="keyword">false</span>;</div><div class="line">    TaskRecord reuseTask = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">//当调用者不是来自activity，而是明确指定task的情况。</span></div><div class="line">    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> &amp;&amp; inTask != <span class="keyword">null</span> &amp;&amp; inTask.stack != <span class="keyword">null</span>) &#123;</div><div class="line">        ... <span class="comment">//目前sourceRecord不为空，则不进入该分支</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        inTask = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (inTask == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//调用者并不是Activity context,则强制创建新task</span></div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span> &amp;&amp; inTask == <span class="keyword">null</span>) &#123;</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord.launchMode == ActivityInfo.LAUNCH_SINGLE_INSTANCE) &#123;</div><div class="line">            <span class="comment">//调用者activity带有single instance，则创建新task</span></div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (launchSingleInstance || launchSingleTask) &#123;</div><div class="line">            <span class="comment">//目标activity带有single instance或者single task，则创建新task</span></div><div class="line">            launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityInfo newTaskInfo = <span class="keyword">null</span>;</div><div class="line">    Intent newTaskIntent = <span class="keyword">null</span>;</div><div class="line">    ActivityStack sourceStack;</div><div class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (sourceRecord.finishing) &#123;</div><div class="line">            <span class="comment">//调用者处于即将finish状态，则创建新task</span></div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) == <span class="number">0</span>) &#123;</div><div class="line">                launchFlags |= Intent.FLAG_ACTIVITY_NEW_TASK;</div><div class="line">                newTaskInfo = sourceRecord.info;</div><div class="line">                newTaskIntent = sourceRecord.task.intent;</div><div class="line">            &#125;</div><div class="line">            sourceRecord = <span class="keyword">null</span>;</div><div class="line">            sourceStack = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//当调用者Activity不为空，且不处于finishing状态，则其所在栈赋于sourceStack</span></div><div class="line">            sourceStack = sourceRecord.task.stack;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        sourceStack = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> movedHome = <span class="keyword">false</span>;</div><div class="line">    ActivityStack targetStack;</div><div class="line"></div><div class="line">    intent.setFlags(launchFlags);</div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> noAnimation = (launchFlags &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (((launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span> &amp;&amp;</div><div class="line">            (launchFlags &amp; Intent.FLAG_ACTIVITY_MULTIPLE_TASK) == <span class="number">0</span>)</div><div class="line">            || launchSingleInstance || launchSingleTask) &#123;</div><div class="line">        <span class="keyword">if</span> (inTask == <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">//从mActivityDisplays开始查询是否有相应ActivityRecord</span></div><div class="line">            ActivityRecord intentActivity = !launchSingleInstance ?</div><div class="line">                    findTaskLocked(r) : findActivityLocked(intent, r.info);</div><div class="line">            <span class="keyword">if</span> (intentActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (isLockTaskModeViolation(intentActivity.task,</div><div class="line">                        (launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))) &#123;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (r.task == <span class="keyword">null</span>) &#123;</div><div class="line">                    r.task = intentActivity.task;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (intentActivity.task.intent == <span class="keyword">null</span>) &#123;</div><div class="line">                    intentActivity.task.setIntent(r);</div><div class="line">                &#125;</div><div class="line">                targetStack = intentActivity.task.stack;</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="keyword">final</span> ActivityStack focusStack = getFocusedStack();</div><div class="line">                ActivityRecord curTop = (focusStack == <span class="keyword">null</span>)</div><div class="line">                        ? <span class="keyword">null</span> : focusStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">                <span class="keyword">boolean</span> movedToFront = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (curTop != <span class="keyword">null</span> &amp;&amp; (curTop.task != intentActivity.task ||</div><div class="line">                        curTop.task != focusStack.topTask())) &#123;</div><div class="line">                    r.intent.addFlags(Intent.FLAG_ACTIVITY_BROUGHT_TO_FRONT);</div><div class="line">                    <span class="keyword">if</span> (sourceRecord == <span class="keyword">null</span> || (sourceStack.topActivity() != <span class="keyword">null</span> &amp;&amp;</div><div class="line">                            sourceStack.topActivity().task == sourceRecord.task)) &#123;</div><div class="line">                        <span class="keyword">if</span> (launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">                            intentActivity.setTaskToAffiliateWith(sourceRecord.task);</div><div class="line">                        &#125;</div><div class="line">                        movedHome = <span class="keyword">true</span>;</div><div class="line">                        <span class="comment">//将该task移至前台</span></div><div class="line">                        targetStack.moveTaskToFrontLocked(intentActivity.task, noAnimation,</div><div class="line">                                options, r.appTimeTracker, <span class="string">"bringingFoundTaskToFront"</span>);</div><div class="line">                        movedToFront = <span class="keyword">true</span>;</div><div class="line">                        <span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">                                (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">                                == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">                            <span class="comment">//将toReturnTo设置为home</span></div><div class="line">                            intentActivity.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">                        &#125;</div><div class="line">                        options = <span class="keyword">null</span>;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                    targetStack.moveToFront(<span class="string">"intentActivityFound"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="comment">//重置目标task</span></div><div class="line">                    intentActivity = targetStack.resetTaskIfNeededLocked(intentActivity, r);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((startFlags &amp; ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                        resumeTopActivitiesLocked(targetStack, <span class="keyword">null</span>, options);</div><div class="line">                        <span class="comment">//当没有启动至前台，则通知Keyguard</span></div><div class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                            notifyActivityDrawnForKeyguard();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> ((launchFlags &amp; (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK))</div><div class="line">                        == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_CLEAR_TASK)) &#123;</div><div class="line">                    reuseTask = intentActivity.task;</div><div class="line">                    <span class="comment">//移除所有跟已存在的task有关联的activity</span></div><div class="line">                    reuseTask.performClearTaskLocked();</div><div class="line">                    reuseTask.setIntent(r);</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags &amp; FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span></div><div class="line">                        || launchSingleInstance || launchSingleTask) &#123;</div><div class="line">                    ActivityRecord top =</div><div class="line">                            intentActivity.task.performClearTaskLocked(r, launchFlags);</div><div class="line">                    <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (top.frontOfTask) &#123;</div><div class="line">                            top.task.setIntent(r);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//触发onNewIntent()</span></div><div class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        sourceRecord = intentActivity;</div><div class="line">                        TaskRecord task = sourceRecord.task;</div><div class="line">                        <span class="keyword">if</span> (task != <span class="keyword">null</span> &amp;&amp; task.stack == <span class="keyword">null</span>) &#123;</div><div class="line">                            targetStack = computeStackFocus(sourceRecord, <span class="keyword">false</span> <span class="comment">/* newTask */</span>);</div><div class="line">                            targetStack.addTask(</div><div class="line">                                    task, !launchTaskBehind <span class="comment">/* toTop */</span>, <span class="keyword">false</span> <span class="comment">/* moving */</span>);</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.realActivity.equals(intentActivity.task.realActivity)) &#123;</div><div class="line">                    <span class="keyword">if</span> (((launchFlags&amp;Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span> || launchSingleTop)</div><div class="line">                            &amp;&amp; intentActivity.realActivity.equals(r.realActivity)) &#123;</div><div class="line">                        <span class="keyword">if</span> (intentActivity.frontOfTask) &#123;</div><div class="line">                            intentActivity.task.setIntent(r);</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//触发onNewIntent()</span></div><div class="line">                        intentActivity.deliverNewIntentLocked(callingUid, r.intent,</div><div class="line">                                r.launchedFromPackage);</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!r.intent.filterEquals(intentActivity.task.intent)) &#123;</div><div class="line">                        addingToTask = <span class="keyword">true</span>;</div><div class="line">                        sourceRecord = intentActivity;</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((launchFlags&amp;Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) == <span class="number">0</span>) &#123;</div><div class="line">                    addingToTask = <span class="keyword">true</span>;</div><div class="line">                    sourceRecord = intentActivity;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!intentActivity.task.rootWasReset) &#123;</div><div class="line">                    intentActivity.task.setIntent(r);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (!addingToTask &amp;&amp; reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                        targetStack.resumeTopActivityLocked(<span class="keyword">null</span>, options);</div><div class="line">                        <span class="keyword">if</span> (!movedToFront) &#123;</div><div class="line">                            notifyActivityDrawnForKeyguard();</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.packageName != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//当启动的activity跟前台显示是同一个的情况</span></div><div class="line">        ActivityStack topStack = mFocusedStack;</div><div class="line">        ActivityRecord top = topStack.topRunningNonDelayedActivityLocked(notTop);</div><div class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; r.resultTo == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">                <span class="keyword">if</span> (top.app != <span class="keyword">null</span> &amp;&amp; top.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">                        || launchSingleTop || launchSingleTask) &#123;</div><div class="line">                        topStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                            resumeTopActivitiesLocked();</div><div class="line">                        &#125;</div><div class="line">                        ActivityOptions.abort(options);</div><div class="line">                        <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//触发onNewIntent()</span></div><div class="line">                        top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                        <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (r.resultTo != <span class="keyword">null</span> &amp;&amp; r.resultTo.task.stack != <span class="keyword">null</span>) &#123;</div><div class="line">            r.resultTo.task.stack.sendActivityResultLocked(-<span class="number">1</span>, r.resultTo, r.resultWho,</div><div class="line">                    r.requestCode, Activity.RESULT_CANCELED, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> ActivityManager.START_CLASS_NOT_FOUND;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> newTask = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">boolean</span> keepCurTransition = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    TaskRecord taskToAffiliate = launchTaskBehind &amp;&amp; sourceRecord != <span class="keyword">null</span> ?</div><div class="line">            sourceRecord.task : <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.resultTo == <span class="keyword">null</span> &amp;&amp; inTask == <span class="keyword">null</span> &amp;&amp; !addingToTask</div><div class="line">            &amp;&amp; (launchFlags &amp; Intent.FLAG_ACTIVITY_NEW_TASK) != <span class="number">0</span>) &#123;</div><div class="line">        newTask = <span class="keyword">true</span>;</div><div class="line">        targetStack = computeStackFocus(r, newTask);</div><div class="line">        targetStack.moveToFront(<span class="string">"startingNewTask"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (reuseTask == <span class="keyword">null</span>) &#123;</div><div class="line">            r.setTask(targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">                    newTaskInfo != <span class="keyword">null</span> ? newTaskInfo : r.info,</div><div class="line">                    newTaskIntent != <span class="keyword">null</span> ? newTaskIntent : intent,</div><div class="line">                    voiceSession, voiceInteractor, !launchTaskBehind <span class="comment">/* toTop */</span>),</div><div class="line">                    taskToAffiliate);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            r.setTask(reuseTask, taskToAffiliate);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(r.task)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!movedHome) &#123;</div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp;</div><div class="line">                    (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME))</div><div class="line">                    == (FLAG_ACTIVITY_NEW_TASK | FLAG_ACTIVITY_TASK_ON_HOME)) &#123;</div><div class="line">                r.task.setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> TaskRecord sourceTask = sourceRecord.task;</div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(sourceTask)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        targetStack = sourceTask.stack;</div><div class="line">        targetStack.moveToFront(<span class="string">"sourceStackToFront"</span>);</div><div class="line">        <span class="keyword">final</span> TaskRecord topTask = targetStack.topTask();</div><div class="line">        <span class="keyword">if</span> (topTask != sourceTask) &#123;</div><div class="line">            targetStack.moveTaskToFrontLocked(sourceTask, noAnimation, options,</div><div class="line">                    r.appTimeTracker, <span class="string">"sourceTaskToFront"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!addingToTask &amp;&amp; (launchFlags&amp;Intent.FLAG_ACTIVITY_CLEAR_TOP) != <span class="number">0</span>) &#123;</div><div class="line">            ActivityRecord top = sourceTask.performClearTaskLocked(r, launchFlags);</div><div class="line">            keepCurTransition = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//触发onNewIntent()</span></div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">                ActivityOptions.abort(options);</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!addingToTask &amp;&amp;</div><div class="line">                (launchFlags&amp;Intent.FLAG_ACTIVITY_REORDER_TO_FRONT) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityRecord top = sourceTask.findActivityInHistoryLocked(r);</div><div class="line">            <span class="keyword">if</span> (top != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> TaskRecord task = top.task;</div><div class="line">                task.moveActivityToFrontLocked(top);</div><div class="line">                top.updateOptionsLocked(options);</div><div class="line">                <span class="comment">//触发onNewIntent()</span></div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">                <span class="keyword">if</span> (doResume) &#123;</div><div class="line">                    targetStack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.setTask(sourceTask, <span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inTask != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (isLockTaskModeViolation(inTask)) &#123;</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_RETURN_LOCK_TASK_MODE_VIOLATION;</div><div class="line">        &#125;</div><div class="line">        targetStack = inTask.stack;</div><div class="line">        targetStack.moveTaskToFrontLocked(inTask, noAnimation, options, r.appTimeTracker,</div><div class="line">                <span class="string">"inTaskToFront"</span>);</div><div class="line"></div><div class="line">        ActivityRecord top = inTask.getTopActivity();</div><div class="line">        <span class="keyword">if</span> (top != <span class="keyword">null</span> &amp;&amp; top.realActivity.equals(r.realActivity) &amp;&amp; top.userId == r.userId) &#123;</div><div class="line">            <span class="keyword">if</span> ((launchFlags &amp; Intent.FLAG_ACTIVITY_SINGLE_TOP) != <span class="number">0</span></div><div class="line">                    || launchSingleTop || launchSingleTask) &#123;</div><div class="line">                <span class="keyword">if</span> ((startFlags&amp;ActivityManager.START_FLAG_ONLY_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> ActivityManager.START_RETURN_INTENT_TO_CALLER;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//触发onNewIntent()</span></div><div class="line">                top.deliverNewIntentLocked(callingUid, r.intent, r.launchedFromPackage);</div><div class="line">                <span class="keyword">return</span> ActivityManager.START_DELIVERED_TO_TOP;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!addingToTask) &#123;</div><div class="line">            ActivityOptions.abort(options);</div><div class="line">            <span class="keyword">return</span> ActivityManager.START_TASK_TO_FRONT;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        r.setTask(inTask, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        targetStack = computeStackFocus(r, newTask);</div><div class="line">        targetStack.moveToFront(<span class="string">"addingToTopTask"</span>);</div><div class="line">        ActivityRecord prev = targetStack.topActivity();</div><div class="line">        r.setTask(prev != <span class="keyword">null</span> ? prev.task : targetStack.createTaskRecord(getNextTaskId(),</div><div class="line">                        r.info, intent, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">true</span>), <span class="keyword">null</span>);</div><div class="line">        mWindowManager.moveTaskToTop(r.task.taskId);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mService.grantUriPermissionFromIntentLocked(callingUid, r.packageName,</div><div class="line">            intent, r.getUriPermissionsLocked(), r.userId);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (sourceRecord != <span class="keyword">null</span> &amp;&amp; sourceRecord.isRecentsActivity()) &#123;</div><div class="line">        r.task.setTaskToReturnTo(RECENTS_ACTIVITY_TYPE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    targetStack.mLastPausedActivity = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">//创建activity [见流程2.10]</span></div><div class="line">    targetStack.startActivityLocked(r, newTask, doResume, keepCurTransition, options);</div><div class="line">    <span class="keyword">if</span> (!launchTaskBehind) &#123;</div><div class="line">        mService.setFocusedActivityLocked(r, <span class="string">"startedActivity"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ActivityManager.START_SUCCESS;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>找到或创建新的Activit所属于的Task对象，之后调用AS.startActivityLocked</p>
<h4 id="2-9-1-Launch-Mode"><a href="#2-9-1-Launch-Mode" class="headerlink" title="2.9.1 Launch Mode"></a>2.9.1 Launch Mode</h4><p>先来说说在ActivityInfo.java中定义了4类Launch Mode：</p>
<ul>
<li>LAUNCH_MULTIPLE(standard)：最常见的情形，每次启动Activity都是创建新的Activity;</li>
<li>LAUNCH_SINGLE_TOP: 当Task顶部存在同一个Activity则不再重新创建；其余情况同上；</li>
<li>LAUNCH_SINGLE_TASK：当Task栈存在同一个Activity(不在task顶部)，则不重新创建，而移除该Activity上面其他的Activity；其余情况同上；</li>
<li>LAUNCH_SINGLE_INSTANCE：每个Task只有一个Activity.</li>
</ul>
<p>再来说说几个常见的flag含义：</p>
<ul>
<li>FLAG_ACTIVITY_NEW_TASK：将Activity放入一个新启动的Task；</li>
<li>FLAG_ACTIVITY_CLEAR_TASK：启动Activity时，将目标Activity关联的Task清除，再启动新Task，将该Activity放入该Task。该flags跟FLAG_ACTIVITY_NEW_TASK配合使用。</li>
<li>FLAG_ACTIVITY_CLEAR_TOP：启动非栈顶Activity时，先清除该Activity之上的Activity。例如Task已有A、B、C3个Activity，启动A，则清除B，C。类似于SingleTop。</li>
</ul>
<p>最后再说说：设置<code>FLAG_ACTIVITY_NEW_TASK</code>的几个情况：</p>
<ul>
<li>调用者并不是Activity context；</li>
<li>调用者activity带有single instance；</li>
<li>目标activity带有single instance或者single task；</li>
<li>调用者处于finishing状态；</li>
</ul>
<h3 id="2-10-AS-startActivityLocked"><a href="#2-10-AS-startActivityLocked" class="headerlink" title="2.10 AS.startActivityLocked"></a>2.10 AS.startActivityLocked</h3><p>[-&gt; ActivityStack.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">startActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> newTask, <span class="keyword">boolean</span> doResume, <span class="keyword">boolean</span> keepCurTransition, Bundle options)</span> </span>&#123;</div><div class="line">    TaskRecord rTask = r.task;</div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> taskId = rTask.taskId;</div><div class="line">    <span class="keyword">if</span> (!r.mLaunchTaskBehind &amp;&amp; (taskForIdLocked(taskId) == <span class="keyword">null</span> || newTask)) &#123;</div><div class="line">        <span class="comment">//task中的上一个activity已被移除，或者ams重用该task,则将该task移到顶部</span></div><div class="line">        insertTaskAtTop(rTask, r);</div><div class="line">        mWindowManager.moveTaskToTop(taskId);</div><div class="line">    &#125;</div><div class="line">    TaskRecord task = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (!newTask) &#123;</div><div class="line">        <span class="keyword">boolean</span> startIt = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> taskNdx = mTaskHistory.size() - <span class="number">1</span>; taskNdx &gt;= <span class="number">0</span>; --taskNdx) &#123;</div><div class="line">            task = mTaskHistory.get(taskNdx);</div><div class="line">            <span class="keyword">if</span> (task.getTopActivity() == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//该task所有activity都finishing</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (task == r.task) &#123;</div><div class="line">                <span class="keyword">if</span> (!startIt) &#123;</div><div class="line">                    task.addActivityToTop(r);</div><div class="line">                    r.putInHistory();</div><div class="line">                    mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">                            r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                            (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>,</div><div class="line">                            r.userId, r.info.configChanges, task.voiceSession != <span class="keyword">null</span>,</div><div class="line">                            r.mLaunchTaskBehind);</div><div class="line">                    ActivityOptions.abort(options);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.numFullscreen &gt; <span class="number">0</span>) &#123;</div><div class="line">                startIt = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (task == r.task &amp;&amp; mTaskHistory.indexOf(task) != (mTaskHistory.size() - <span class="number">1</span>)) &#123;</div><div class="line">        mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    task = r.task;</div><div class="line">    task.addActivityToTop(r);</div><div class="line">    task.setFrontOfTask();</div><div class="line"></div><div class="line">    r.putInHistory();</div><div class="line">    mActivityTrigger.activityStartTrigger(r.intent, r.info, r.appInfo);</div><div class="line">    <span class="keyword">if</span> (!isHomeStack() || numActivities() &gt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="comment">//当切换到新的task，或者下一个activity进程目前并没有运行，则</span></div><div class="line">        <span class="keyword">boolean</span> showStartingIcon = newTask;</div><div class="line">        ProcessRecord proc = r.app;</div><div class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span>) &#123;</div><div class="line">            proc = mService.mProcessNames.get(r.processName, r.info.applicationInfo.uid);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (proc == <span class="keyword">null</span> || proc.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            showStartingIcon = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_ANIMATION) != <span class="number">0</span>) &#123;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, keepCurTransition);</div><div class="line">            mNoAnimActivities.add(r);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mWindowManager.prepareAppTransition(newTask</div><div class="line">                    ? r.mLaunchTaskBehind</div><div class="line">                            ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">                            : AppTransition.TRANSIT_TASK_OPEN</div><div class="line">                    : AppTransition.TRANSIT_ACTIVITY_OPEN, keepCurTransition);</div><div class="line">            mNoAnimActivities.remove(r);</div><div class="line">        &#125;</div><div class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r),</div><div class="line">                r.appToken, r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">        <span class="keyword">boolean</span> doShow = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (newTask) &#123;</div><div class="line">            <span class="keyword">if</span> ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED) != <span class="number">0</span>) &#123;</div><div class="line">                resetTaskIfNeededLocked(r, r);</div><div class="line">                doShow = topRunningNonDelayedActivityLocked(<span class="keyword">null</span>) == r;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (options != <span class="keyword">null</span> &amp;&amp; <span class="keyword">new</span> ActivityOptions(options).getAnimationType()</div><div class="line">                == ActivityOptions.ANIM_SCENE_TRANSITION) &#123;</div><div class="line">            doShow = <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (r.mLaunchTaskBehind) &#123;</div><div class="line">            mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">            ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW &amp;&amp; doShow) &#123;</div><div class="line">            ActivityRecord prev = mResumedActivity;</div><div class="line">            <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//当前activity所属不同的task</span></div><div class="line">                <span class="keyword">if</span> (prev.task != r.task) &#123;</div><div class="line">                    prev = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="comment">//当前activity已经displayed</span></div><div class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (prev.nowVisible) &#123;</div><div class="line">                    prev = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            mWindowManager.setAppStartingWindow(</div><div class="line">                    r.appToken, r.packageName, r.theme,</div><div class="line">                    mService.compatibilityInfoForPackageLocked(</div><div class="line">                             r.info.applicationInfo), r.nonLocalizedLabel,</div><div class="line">                    r.labelRes, r.icon, r.logo, r.windowFlags,</div><div class="line">                    prev != <span class="keyword">null</span> ? prev.appToken : <span class="keyword">null</span>, showStartingIcon);</div><div class="line">            r.mStartingWindowShown = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mWindowManager.addAppToken(task.mActivities.indexOf(r), r.appToken,</div><div class="line">                r.task.taskId, mStackId, r.info.screenOrientation, r.fullscreen,</div><div class="line">                (r.info.flags &amp; ActivityInfo.FLAG_SHOW_FOR_ALL_USERS) != <span class="number">0</span>, r.userId,</div><div class="line">                r.info.configChanges, task.voiceSession != <span class="keyword">null</span>, r.mLaunchTaskBehind);</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        options = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (doResume) &#123;</div><div class="line">        <span class="comment">// [见流程2.11]</span></div><div class="line">        mStackSupervisor.resumeTopActivitiesLocked(<span class="keyword">this</span>, r, options);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-11-ASS-resumeTopActivitiesLocked"><a href="#2-11-ASS-resumeTopActivitiesLocked" class="headerlink" title="2.11 ASS.resumeTopActivitiesLocked"></a>2.11 ASS.resumeTopActivitiesLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">resumeTopActivitiesLocked</span><span class="params">(ActivityStack targetStack, ActivityRecord target, Bundle targetOptions)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (targetStack == <span class="keyword">null</span>) &#123;</div><div class="line">        targetStack = mFocusedStack;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">if</span> (isFrontStack(targetStack)) &#123;</div><div class="line">        <span class="comment">//[见流程2.12]</span></div><div class="line">        result = targetStack.resumeTopActivityLocked(target, targetOptions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        <span class="keyword">final</span> ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (stack == targetStack) &#123;</div><div class="line">                <span class="comment">//上面刚已启动</span></div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (isFrontStack(stack)) &#123;</div><div class="line">                stack.resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-12-AS-resumeTopActivityLocked"><a href="#2-12-AS-resumeTopActivityLocked" class="headerlink" title="2.12 AS.resumeTopActivityLocked"></a>2.12 AS.resumeTopActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mStackSupervisor.inResumeTopActivity) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//防止递归启动</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mService.mLockScreenShown == ActivityManagerService.LOCK_SCREEN_LEAVING) &#123;</div><div class="line">            mService.mLockScreenShown = ActivityManagerService.LOCK_SCREEN_HIDDEN;</div><div class="line">            mService.updateSleepIfNeededLocked();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//[见流程2.13]</span></div><div class="line">        result = resumeTopActivityInnerLocked(prev, options);</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        mStackSupervisor.inResumeTopActivity = <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>inResumeTopActivity用于保证每次只有一个Activity执行resumeTopActivityLocked()操作.</p>
<h3 id="2-13-AS-resumeTopActivityInnerLocked"><a href="#2-13-AS-resumeTopActivityInnerLocked" class="headerlink" title="2.13 AS.resumeTopActivityInnerLocked"></a>2.13 AS.resumeTopActivityInnerLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">resumeTopActivityInnerLocked</span><span class="params">(ActivityRecord prev, Bundle options)</span> </span>&#123;</div><div class="line">    ... <span class="comment">//系统没有进入booting或booted状态，则不允许启动Activity</span></div><div class="line"></div><div class="line">    ActivityRecord parent = mActivityContainer.mParentActivity;</div><div class="line">    <span class="keyword">if</span> ((parent != <span class="keyword">null</span> &amp;&amp; parent.state != ActivityState.RESUMED) ||</div><div class="line">            !mActivityContainer.isAttachedLocked()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//top running之后的任意处于初始化状态且有显示StartingWindow, 则移除StartingWindow</span></div><div class="line">    cancelInitializingActivities();</div><div class="line"></div><div class="line">    <span class="comment">//找到第一个没有finishing的栈顶activity</span></div><div class="line">    <span class="keyword">final</span> ActivityRecord next = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> userLeaving = mStackSupervisor.mUserLeaving;</div><div class="line">    mStackSupervisor.mUserLeaving = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord prevTask = prev != <span class="keyword">null</span> ? prev.task : <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (next == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> String reason = <span class="string">"noMoreActivities"</span>;</div><div class="line">        <span class="keyword">if</span> (!mFullscreen) &#123;</div><div class="line">            <span class="comment">//当该栈没有全屏，则尝试聚焦到下一个可见的stack</span></div><div class="line">            <span class="keyword">final</span> ActivityStack stack = getNextVisibleStackLocked();</div><div class="line">            <span class="keyword">if</span> (adjustFocusToNextVisibleStackLocked(stack, reason)) &#123;</div><div class="line">                <span class="keyword">return</span> mStackSupervisor.resumeTopActivitiesLocked(stack, prev, <span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</div><div class="line">                HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</div><div class="line">        <span class="comment">//启动home桌面activity</span></div><div class="line">        <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</div><div class="line">                mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, reason);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    next.delayedResume = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mResumedActivity == next &amp;&amp; next.state == ActivityState.RESUMED &amp;&amp;</div><div class="line">                mStackSupervisor.allResumedActivitiesComplete()) &#123;</div><div class="line">        mWindowManager.executeAppTransition();</div><div class="line">        mNoAnimActivities.clear();</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord nextTask = next.task;</div><div class="line">    <span class="keyword">if</span> (prevTask != <span class="keyword">null</span> &amp;&amp; prevTask.stack == <span class="keyword">this</span> &amp;&amp;</div><div class="line">            prevTask.isOverHomeStack() &amp;&amp; prev.finishing &amp;&amp; prev.frontOfTask) &#123;</div><div class="line">        <span class="keyword">if</span> (prevTask == nextTask) &#123;</div><div class="line">            prevTask.setFrontOfTask();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prevTask != topTask()) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> taskNdx = mTaskHistory.indexOf(prevTask) + <span class="number">1</span>;</div><div class="line">            mTaskHistory.get(taskNdx).setTaskToReturnTo(HOME_ACTIVITY_TYPE);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isOnHomeDisplay()) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isHomeStack())&#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> returnTaskType = prevTask == <span class="keyword">null</span> || !prevTask.isOverHomeStack() ?</div><div class="line">                    HOME_ACTIVITY_TYPE : prevTask.getTaskToReturnTo();</div><div class="line">            <span class="keyword">return</span> isOnHomeDisplay() &amp;&amp;</div><div class="line">                    mStackSupervisor.resumeHomeStackTask(returnTaskType, prev, <span class="string">"prevFinished"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//处于睡眠或者关机状态，top activity已暂停的情况下</span></div><div class="line">    <span class="keyword">if</span> (mService.isSleepingOrShuttingDown()</div><div class="line">            &amp;&amp; mLastPausedActivity == next</div><div class="line">            &amp;&amp; mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        mWindowManager.executeAppTransition();</div><div class="line">        mNoAnimActivities.clear();</div><div class="line">        ActivityOptions.abort(options);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.mStartedUsers.get(next.userId) == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//拥有该activity的用户没有启动则直接返回</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStackSupervisor.mStoppingActivities.remove(next);</div><div class="line">    mStackSupervisor.mGoingToSleepActivities.remove(next);</div><div class="line">    next.sleeping = <span class="keyword">false</span>;</div><div class="line">    mStackSupervisor.mWaitingVisibleActivities.remove(next);</div><div class="line"></div><div class="line">    mActivityTrigger.activityResumeTrigger(next.intent, next.info, next.appInfo);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!mStackSupervisor.allPausedActivitiesComplete()) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">//当正处于暂停activity，则直接返回</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStackSupervisor.setLaunchSource(next.info.applicationInfo.uid);</div><div class="line"></div><div class="line">    <span class="comment">//需要等待暂停当前activity完成，再resume top activity</span></div><div class="line">    <span class="keyword">boolean</span> dontWaitForPause = (next.info.flags&amp;ActivityInfo.FLAG_RESUME_WHILE_PAUSING) != <span class="number">0</span>;</div><div class="line">    <span class="comment">//暂停其他Activity[见小节2.13.1]</span></div><div class="line">    <span class="keyword">boolean</span> pausing = mStackSupervisor.pauseBackStacks(userLeaving, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    <span class="keyword">if</span> (mResumedActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//当前resumd状态activity不为空，则需要先暂停该Activity</span></div><div class="line">        pausing |= startPausingLocked(userLeaving, <span class="keyword">false</span>, <span class="keyword">true</span>, dontWaitForPause);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (pausing) &#123;</div><div class="line">        <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">            mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (mService.isSleeping() &amp;&amp; mLastNoHistoryActivity != <span class="keyword">null</span> &amp;&amp;</div><div class="line">            !mLastNoHistoryActivity.finishing) &#123;</div><div class="line">        requestFinishActivityLocked(mLastNoHistoryActivity.appToken, Activity.RESULT_CANCELED,</div><div class="line">                <span class="keyword">null</span>, <span class="string">"resume-no-history"</span>, <span class="keyword">false</span>);</div><div class="line">        mLastNoHistoryActivity = <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span> &amp;&amp; prev != next) &#123;</div><div class="line">        <span class="keyword">if</span> (!mStackSupervisor.mWaitingVisibleActivities.contains(prev)</div><div class="line">                &amp;&amp; next != <span class="keyword">null</span> &amp;&amp; !next.nowVisible) &#123;</div><div class="line">            mStackSupervisor.mWaitingVisibleActivities.add(prev);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (prev.finishing) &#123;</div><div class="line">                mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AppGlobals.getPackageManager().setPackageStoppedState(</div><div class="line">            next.packageName, <span class="keyword">false</span>, next.userId);</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> anim = <span class="keyword">true</span>;</div><div class="line">    <span class="keyword">if</span> (mIsAnimationBoostEnabled == <span class="keyword">true</span> &amp;&amp; mPerf == <span class="keyword">null</span>) &#123;</div><div class="line">        mPerf = <span class="keyword">new</span> BoostFramework();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (prev != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (prev.finishing) &#123;</div><div class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(prev)) &#123;</div><div class="line">                anim = <span class="keyword">false</span>;</div><div class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</div><div class="line">                        ? AppTransition.TRANSIT_ACTIVITY_CLOSE</div><div class="line">                        : AppTransition.TRANSIT_TASK_CLOSE, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">if</span>(prev.task != next.task &amp;&amp; mPerf != <span class="keyword">null</span>) &#123;</div><div class="line">                   mPerf.perfLockAcquire(aBoostTimeOut, aBoostParamVal);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            mWindowManager.setAppWillBeHidden(prev.appToken);</div><div class="line">            mWindowManager.setAppVisibility(prev.appToken, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</div><div class="line">                anim = <span class="keyword">false</span>;</div><div class="line">                mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mWindowManager.prepareAppTransition(prev.task == next.task</div><div class="line">                        ? AppTransition.TRANSIT_ACTIVITY_OPEN</div><div class="line">                        : next.mLaunchTaskBehind</div><div class="line">                                ? AppTransition.TRANSIT_TASK_OPEN_BEHIND</div><div class="line">                                : AppTransition.TRANSIT_TASK_OPEN, <span class="keyword">false</span>);</div><div class="line">                <span class="keyword">if</span>(prev.task != next.task &amp;&amp; mPerf != <span class="keyword">null</span>) &#123;</div><div class="line">                    mPerf.perfLockAcquire(aBoostTimeOut, aBoostParamVal);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mNoAnimActivities.contains(next)) &#123;</div><div class="line">            anim = <span class="keyword">false</span>;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_NONE, <span class="keyword">false</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mWindowManager.prepareAppTransition(AppTransition.TRANSIT_ACTIVITY_OPEN, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Bundle resumeAnimOptions = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (anim) &#123;</div><div class="line">        ActivityOptions opts = next.getOptionsForTargetActivityLocked();</div><div class="line">        <span class="keyword">if</span> (opts != <span class="keyword">null</span>) &#123;</div><div class="line">            resumeAnimOptions = opts.toBundle();</div><div class="line">        &#125;</div><div class="line">        next.applyOptionsLocked();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        next.clearOptionsLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ActivityStack lastStack = mStackSupervisor.getLastStack();</div><div class="line">    <span class="comment">//进程已存在的情况</span></div><div class="line">    <span class="keyword">if</span> (next.app != <span class="keyword">null</span> &amp;&amp; next.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">//activity正在成为可见</span></div><div class="line">        mWindowManager.setAppVisibility(next.appToken, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">        next.startLaunchTickingLocked();</div><div class="line"></div><div class="line">        ActivityRecord lastResumedActivity = lastStack == <span class="keyword">null</span> ? <span class="keyword">null</span> :lastStack.mResumedActivity;</div><div class="line">        ActivityState lastState = next.state;</div><div class="line"></div><div class="line">        mService.updateCpuStats();</div><div class="line">        <span class="comment">//设置Activity状态为resumed</span></div><div class="line">        next.state = ActivityState.RESUMED;</div><div class="line">        mResumedActivity = next;</div><div class="line">        next.task.touchActiveTime();</div><div class="line">        mRecentTasks.addLocked(next.task);</div><div class="line">        mService.updateLruProcessLocked(next.app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">        updateLRUListLocked(next);</div><div class="line">        mService.updateOomAdjLocked();</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> notUpdated = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">if</span> (mStackSupervisor.isFrontStack(<span class="keyword">this</span>)) &#123;</div><div class="line">            Configuration config = mWindowManager.updateOrientationFromAppTokens(</div><div class="line">                    mService.mConfiguration,</div><div class="line">                    next.mayFreezeScreenLocked(next.app) ? next.appToken : <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (config != <span class="keyword">null</span>) &#123;</div><div class="line">                next.frozenBeforeDestroy = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            notUpdated = !mService.updateConfigurationLocked(config, next, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (notUpdated) &#123;</div><div class="line">            ActivityRecord nextNext = topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (nextNext != next) &#123;</div><div class="line">                mStackSupervisor.scheduleResumeTopActivities();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mStackSupervisor.reportResumedActivityLocked(next)) &#123;</div><div class="line">                mNoAnimActivities.clear();</div><div class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">//分发所有pending结果.</span></div><div class="line">            ArrayList&lt;ResultInfo&gt; a = next.results;</div><div class="line">            <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = a.size();</div><div class="line">                <span class="keyword">if</span> (!next.finishing &amp;&amp; N &gt; <span class="number">0</span>) &#123;</div><div class="line">                    next.app.thread.scheduleSendResult(next.appToken, a);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (next.newIntents != <span class="keyword">null</span>) &#123;</div><div class="line">                next.app.thread.scheduleNewIntent(next.newIntents, next.appToken);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            next.sleeping = <span class="keyword">false</span>;</div><div class="line">            mService.showAskCompatModeDialogLocked(next);</div><div class="line">            next.app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">            next.app.forceProcessStateUpTo(mService.mTopProcessState);</div><div class="line">            next.clearOptionsLocked();</div><div class="line">            <span class="comment">//触发onResume()</span></div><div class="line">            next.app.thread.scheduleResumeActivity(next.appToken, next.app.repProcState,</div><div class="line">                    mService.isNextTransitionForward(), resumeAnimOptions);</div><div class="line"></div><div class="line">            mStackSupervisor.checkReadyForSleepLocked();</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            ...</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        next.visible = <span class="keyword">true</span>;</div><div class="line">        completeResumeLocked(next);</div><div class="line">        next.stopped = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (!next.hasBeenLaunched) &#123;</div><div class="line">            next.hasBeenLaunched = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (SHOW_APP_STARTING_PREVIEW) &#123;</div><div class="line">                mWindowManager.setAppStartingWindow(</div><div class="line">                        next.appToken, next.packageName, next.theme,</div><div class="line">                        mService.compatibilityInfoForPackageLocked(</div><div class="line">                                next.info.applicationInfo),</div><div class="line">                        next.nonLocalizedLabel,</div><div class="line">                        next.labelRes, next.icon, next.logo, next.windowFlags,</div><div class="line">                        <span class="keyword">null</span>, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mStackSupervisor.startSpecificActivityLocked(next, <span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要分支功能：</p>
<ul>
<li>当找不到需要resume的Activity，则直接回到桌面；</li>
<li>否则，当mResumedActivity不为空，则执行startPausingLocked()暂停该activity;</li>
<li>然后再进入startSpecificActivityLocked环节，接下来从这里继续往下说。</li>
</ul>
<h4 id="2-13-1-ASS-pauseBackStacks"><a href="#2-13-1-ASS-pauseBackStacks" class="headerlink" title="2.13.1 ASS.pauseBackStacks"></a>2.13.1 ASS.pauseBackStacks</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">pauseBackStacks</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> someActivityPaused = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (!isFrontStack(stack) &amp;&amp; stack.mResumedActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">//[见小节2.13.2]</span></div><div class="line">                someActivityPaused |= stack.startPausingLocked(userLeaving, <span class="keyword">false</span>, resuming,</div><div class="line">                        dontWait);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> someActivityPaused;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>暂停所有处于后台栈的所有Activity。</p>
<h4 id="2-13-2-AS-startPausingLocked"><a href="#2-13-2-AS-startPausingLocked" class="headerlink" title="2.13.2 AS.startPausingLocked"></a>2.13.2 AS.startPausingLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">startPausingLocked</span><span class="params">(<span class="keyword">boolean</span> userLeaving, <span class="keyword">boolean</span> uiSleeping, <span class="keyword">boolean</span> resuming, <span class="keyword">boolean</span> dontWait)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (!mService.isSleeping()) &#123;</div><div class="line">          completePauseLocked(<span class="keyword">false</span>);</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">  ActivityRecord prev = mResumedActivity;</div><div class="line">  ...</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (mActivityContainer.mParentActivity == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//暂停所有子栈的Activity</span></div><div class="line">      mStackSupervisor.pauseChildStacks(prev, userLeaving, uiSleeping, resuming, dontWait);</div><div class="line">  &#125;</div><div class="line">  ...</div><div class="line">  <span class="keyword">final</span> ActivityRecord next = mStackSupervisor.topRunningActivityLocked();</div><div class="line">  </div><div class="line">  <span class="keyword">if</span> (prev.app != <span class="keyword">null</span> &amp;&amp; prev.app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">      EventLog.writeEvent(EventLogTags.AM_PAUSE_ACTIVITY,</div><div class="line">              prev.userId, System.identityHashCode(prev),</div><div class="line">              prev.shortComponentName);</div><div class="line">      mService.updateUsageStats(prev, <span class="keyword">false</span>);</div><div class="line">      <span class="comment">//暂停目标Activity</span></div><div class="line">      prev.app.thread.schedulePauseActivity(prev.appToken, prev.finishing,</div><div class="line">              userLeaving, prev.configChangeFlags, dontWait);</div><div class="line">  &#125;<span class="keyword">else</span> &#123;</div><div class="line">      ...</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (!uiSleeping &amp;&amp; !mService.isSleepingOrShuttingDown()) &#123;</div><div class="line">      mStackSupervisor.acquireLaunchWakelock(); <span class="comment">//申请wakelock</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (mPausingActivity != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (!uiSleeping) &#123;</div><div class="line">          prev.pauseKeyDispatchingLocked();</div><div class="line">      &#125; </div><div class="line"></div><div class="line">      <span class="keyword">if</span> (dontWait) &#123;</div><div class="line">          completePauseLocked(<span class="keyword">false</span>); </div><div class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Message msg = mHandler.obtainMessage(PAUSE_TIMEOUT_MSG);</div><div class="line">          msg.obj = prev;</div><div class="line">          prev.pauseTime = SystemClock.uptimeMillis();</div><div class="line">          <span class="comment">//500ms后，执行暂停超时的消息</span></div><div class="line">          mHandler.sendMessageDelayed(msg, PAUSE_TIMEOUT);</div><div class="line">          <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">      <span class="keyword">if</span> (!resuming) &#123; <span class="comment">//调度暂停失败，则认为已暂停完成，开始执行resume操作</span></div><div class="line">          mStackSupervisor.getFocusedStack().resumeTopActivityLocked(<span class="keyword">null</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>该方法中，下一步通过Binder调用，进入acitivity所在进程来执行schedulePauseActivity()操作。 接下来，对于dontWait=true则执行执行completePauseLocked，否则等待app通知或许500ms超时再执行该方法。</p>
<h4 id="3-13-3-completePauseLocked"><a href="#3-13-3-completePauseLocked" class="headerlink" title="3.13.3 completePauseLocked"></a>3.13.3 completePauseLocked</h4><h3 id="2-14-ASS-startSpecificActivityLocked"><a href="#2-14-ASS-startSpecificActivityLocked" class="headerlink" title="2.14 ASS.startSpecificActivityLocked"></a>2.14 ASS.startSpecificActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">startSpecificActivityLocked</span><span class="params">(ActivityRecord r, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> </span>&#123;</div><div class="line">    ProcessRecord app = mService.getProcessRecordLocked(r.processName,</div><div class="line">            r.info.applicationInfo.uid, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">    r.task.stack.setLaunchTime(r);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (app != <span class="keyword">null</span> &amp;&amp; app.thread != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">if</span> ((r.info.flags&amp;ActivityInfo.FLAG_MULTIPROCESS) == <span class="number">0</span></div><div class="line">                    || !<span class="string">"android"</span>.equals(r.info.packageName)) &#123;</div><div class="line">                app.addPackage(r.info.packageName, r.info.applicationInfo.versionCode,</div><div class="line">                        mService.mProcessStats);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//真正的启动Activity【见流程2.17】</span></div><div class="line">            realStartActivityLocked(r, app, andResume, checkConfig);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">            Slog.w(TAG, <span class="string">"Exception when starting activity "</span></div><div class="line">                    + r.intent.getComponent().flattenToShortString(), e);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="comment">//当进程不存在则创建进程 [见流程2.14.1]</span></div><div class="line">    mService.startProcessLocked(r.processName, r.info.applicationInfo, <span class="keyword">true</span>, <span class="number">0</span>,</div><div class="line">            <span class="string">"activity"</span>, r.intent.getComponent(), <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">true</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-15-AMS-startProcessLocked"><a href="#2-15-AMS-startProcessLocked" class="headerlink" title="2.15 AMS.startProcessLocked"></a>2.15 AMS.startProcessLocked</h4><p>在文章<a href="http://gityuan.com/2016/10/09/app-process-create-2/" target="_blank" rel="external">理解Android进程启动之全过程</a>中，详细介绍了AMS.startProcessLocked()整个过程，创建完新进程后会在新进程中调用<code>AMP.attachApplication</code>，该方法经过binder ipc后调用到<code>AMS.attachApplicationLocked</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(IApplicationThread thread, <span class="keyword">int</span> pid)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="comment">////只有当系统启动完，或者app允许启动过程允许，则会true</span></div><div class="line">    <span class="keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);</div><div class="line">    thread.bindApplication(...);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (normalMode) &#123;</div><div class="line">        <span class="comment">//【见流程2.16】</span></div><div class="line">        <span class="keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;</div><div class="line">            didSomething = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在执行完bindApplication()之后进入ASS.attachApplicationLocked()</p>
<h4 id="2-16-ASS-attachApplicationLocked"><a href="#2-16-ASS-attachApplicationLocked" class="headerlink" title="2.16 ASS.attachApplicationLocked"></a>2.16 ASS.attachApplicationLocked</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">attachApplicationLocked</span><span class="params">(ProcessRecord app)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">final</span> String processName = app.processName;</div><div class="line">    <span class="keyword">boolean</span> didSomething = <span class="keyword">false</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> displayNdx = mActivityDisplays.size() - <span class="number">1</span>; displayNdx &gt;= <span class="number">0</span>; --displayNdx) &#123;</div><div class="line">        ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.valueAt(displayNdx).mStacks;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> stackNdx = stacks.size() - <span class="number">1</span>; stackNdx &gt;= <span class="number">0</span>; --stackNdx) &#123;</div><div class="line">            <span class="keyword">final</span> ActivityStack stack = stacks.get(stackNdx);</div><div class="line">            <span class="keyword">if</span> (!isFrontStack(stack)) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="comment">//获取前台stack中栈顶第一个非finishing的Activity</span></div><div class="line">            ActivityRecord hr = stack.topRunningActivityLocked(<span class="keyword">null</span>);</div><div class="line">            <span class="keyword">if</span> (hr != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">if</span> (hr.app == <span class="keyword">null</span> &amp;&amp; app.uid == hr.info.applicationInfo.uid</div><div class="line">                        &amp;&amp; processName.equals(hr.processName)) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">//真正的启动Activity【见流程2.17】</span></div><div class="line">                        <span class="keyword">if</span> (realStartActivityLocked(hr, app, <span class="keyword">true</span>, <span class="keyword">true</span>)) &#123;</div><div class="line">                            didSomething = <span class="keyword">true</span>;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">                        <span class="keyword">throw</span> e;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!didSomething) &#123;</div><div class="line">        <span class="comment">//启动Activity不成功，则确保有可见的Activity</span></div><div class="line">        ensureActivitiesVisibleLocked(<span class="keyword">null</span>, <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> didSomething;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-17-ASS-realStartActivityLocked"><a href="#2-17-ASS-realStartActivityLocked" class="headerlink" title="2.17 ASS.realStartActivityLocked"></a>2.17 ASS.realStartActivityLocked</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">realStartActivityLocked</span><span class="params">(ActivityRecord r, ProcessRecord app, <span class="keyword">boolean</span> andResume, <span class="keyword">boolean</span> checkConfig)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (andResume) &#123;</div><div class="line">        r.startFreezingScreenLocked(app, <span class="number">0</span>);</div><div class="line">        mWindowManager.setAppVisibility(r.appToken, <span class="keyword">true</span>);</div><div class="line">        <span class="comment">//调度启动ticks用以收集应用启动慢的信息</span></div><div class="line">        r.startLaunchTickingLocked();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (checkConfig) &#123;</div><div class="line">        Configuration config = mWindowManager.updateOrientationFromAppTokens(</div><div class="line">                mService.mConfiguration,</div><div class="line">                r.mayFreezeScreenLocked(app) ? r.appToken : <span class="keyword">null</span>);</div><div class="line">        <span class="comment">//更新Configuration</span></div><div class="line">        mService.updateConfigurationLocked(config, r, <span class="keyword">false</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    r.app = app;</div><div class="line">    app.waitingToKill = <span class="keyword">null</span>;</div><div class="line">    r.launchCount++;</div><div class="line">    r.lastLaunchTime = SystemClock.uptimeMillis();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> idx = app.activities.indexOf(r);</div><div class="line">    <span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</div><div class="line">        app.activities.add(r);</div><div class="line">    &#125;</div><div class="line">    mService.updateLruProcessLocked(app, <span class="keyword">true</span>, <span class="keyword">null</span>);</div><div class="line">    mService.updateOomAdjLocked();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> TaskRecord task = r.task;</div><div class="line">    <span class="keyword">if</span> (task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE ||</div><div class="line">            task.mLockTaskAuth == LOCK_TASK_AUTH_LAUNCHABLE_PRIV) &#123;</div><div class="line">        setLockTaskModeLocked(task, LOCK_TASK_MODE_LOCKED, <span class="string">"mLockTaskAuth==LAUNCHABLE"</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">final</span> ActivityStack stack = task.stack;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">if</span> (app.thread == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RemoteException();</div><div class="line">        &#125;</div><div class="line">        List&lt;ResultInfo&gt; results = <span class="keyword">null</span>;</div><div class="line">        List&lt;ReferrerIntent&gt; newIntents = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            results = r.results;</div><div class="line">            newIntents = r.newIntents;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (r.isHomeActivity() &amp;&amp; r.isNotResolverActivity()) &#123;</div><div class="line">            <span class="comment">//home进程是该栈的根进程</span></div><div class="line">            mService.mHomeProcess = task.mActivities.get(<span class="number">0</span>).app;</div><div class="line">        &#125;</div><div class="line">        mService.ensurePackageDexOpt(r.intent.getComponent().getPackageName());</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (andResume) &#123;</div><div class="line">            app.hasShownUi = <span class="keyword">true</span>;</div><div class="line">            app.pendingUiClean = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//将该进程设置为前台进程PROCESS_STATE_TOP</span></div><div class="line">        app.forceProcessStateUpTo(mService.mTopProcessState);</div><div class="line">        <span class="comment">//【见流程2.18】</span></div><div class="line">        app.thread.scheduleLaunchActivity(<span class="keyword">new</span> Intent(r.intent), r.appToken,</div><div class="line">                System.identityHashCode(r), r.info, <span class="keyword">new</span> Configuration(mService.mConfiguration),</div><div class="line">                <span class="keyword">new</span> Configuration(stack.mOverrideConfig), r.compat, r.launchedFromPackage,</div><div class="line">                task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,</div><div class="line">                newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="number">0</span>) &#123;</div><div class="line">            ... <span class="comment">//处理heavy-weight进程</span></div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">        <span class="keyword">if</span> (r.launchFailed) &#123;</div><div class="line">            <span class="comment">//第二次启动失败，则结束该activity</span></div><div class="line">            mService.appDiedLocked(app);</div><div class="line">            stack.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="keyword">null</span>,</div><div class="line">                    <span class="string">"2nd-crash"</span>, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//这是第一个启动失败，则重启进程</span></div><div class="line">        app.activities.remove(r);</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//将该进程加入到mLRUActivities队列顶部</span></div><div class="line">    stack.updateLRUListLocked(r)；</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (andResume) &#123;</div><div class="line">        <span class="comment">//启动过程的一部分</span></div><div class="line">        stack.minimalResumeActivityLocked(r);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        r.state = STOPPED;</div><div class="line">        r.stopped = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isFrontStack(stack)) &#123;</div><div class="line">        <span class="comment">//当系统发生更新时，只会执行一次的用户向导</span></div><div class="line">        mService.startSetupActivityLocked();</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//更新所有与该Activity具有绑定关系的Service连接</span></div><div class="line">    mService.mServices.updateServiceConnectionActivitiesLocked(r.app);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-18-ATP-scheduleLaunchActivity"><a href="#2-18-ATP-scheduleLaunchActivity" class="headerlink" title="2.18 ATP.scheduleLaunchActivity"></a>2.18 ATP.scheduleLaunchActivity</h3><p>[-&gt; ApplicationThreadProxy.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident, ActivityInfo info, Configuration curConfig, Configuration overrideConfig, CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState, List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">     Parcel data = Parcel.obtain();</div><div class="line">     data.writeInterfaceToken(IApplicationThread.descriptor);</div><div class="line">     intent.writeToParcel(data, <span class="number">0</span>);</div><div class="line">     data.writeStrongBinder(token);</div><div class="line">     data.writeInt(ident);</div><div class="line">     info.writeToParcel(data, <span class="number">0</span>);</div><div class="line">     curConfig.writeToParcel(data, <span class="number">0</span>);</div><div class="line">     <span class="keyword">if</span> (overrideConfig != <span class="keyword">null</span>) &#123;</div><div class="line">         data.writeInt(<span class="number">1</span>);</div><div class="line">         overrideConfig.writeToParcel(data, <span class="number">0</span>);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         data.writeInt(<span class="number">0</span>);</div><div class="line">     &#125;</div><div class="line">     compatInfo.writeToParcel(data, <span class="number">0</span>);</div><div class="line">     data.writeString(referrer);</div><div class="line">     data.writeStrongBinder(voiceInteractor != <span class="keyword">null</span> ? voiceInteractor.asBinder() : <span class="keyword">null</span>);</div><div class="line">     data.writeInt(procState);</div><div class="line">     data.writeBundle(state);</div><div class="line">     data.writePersistableBundle(persistentState);</div><div class="line">     data.writeTypedList(pendingResults);</div><div class="line">     data.writeTypedList(pendingNewIntents);</div><div class="line">     data.writeInt(notResumed ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">     data.writeInt(isForward ? <span class="number">1</span> : <span class="number">0</span>);</div><div class="line">     <span class="keyword">if</span> (profilerInfo != <span class="keyword">null</span>) &#123;</div><div class="line">         data.writeInt(<span class="number">1</span>);</div><div class="line">         profilerInfo.writeToParcel(data, Parcelable.PARCELABLE_WRITE_RETURN_VALUE);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         data.writeInt(<span class="number">0</span>);</div><div class="line">     &#125;</div><div class="line">     <span class="comment">//【见流程2.19】</span></div><div class="line">     mRemote.transact(SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION, data, <span class="keyword">null</span>,</div><div class="line">             IBinder.FLAG_ONEWAY);</div><div class="line">     data.recycle();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="2-19-ATN-onTransact"><a href="#2-19-ATN-onTransact" class="headerlink" title="2.19 ATN.onTransact"></a>2.19 ATN.onTransact</h3><p>[-&gt; ApplicationThreadNative.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTransact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (code) &#123;</div><div class="line">    <span class="keyword">case</span> SCHEDULE_LAUNCH_ACTIVITY_TRANSACTION:</div><div class="line">    &#123;</div><div class="line">        data.enforceInterface(IApplicationThread.descriptor);</div><div class="line">        Intent intent = Intent.CREATOR.createFromParcel(data);</div><div class="line">        IBinder b = data.readStrongBinder();</div><div class="line">        <span class="keyword">int</span> ident = data.readInt();</div><div class="line">        ActivityInfo info = ActivityInfo.CREATOR.createFromParcel(data);</div><div class="line">        Configuration curConfig = Configuration.CREATOR.createFromParcel(data);</div><div class="line">        Configuration overrideConfig = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (data.readInt() != <span class="number">0</span>) &#123;</div><div class="line">            overrideConfig = Configuration.CREATOR.createFromParcel(data);</div><div class="line">        &#125;</div><div class="line">        CompatibilityInfo compatInfo = CompatibilityInfo.CREATOR.createFromParcel(data);</div><div class="line">        String referrer = data.readString();</div><div class="line">        IVoiceInteractor voiceInteractor = IVoiceInteractor.Stub.asInterface(</div><div class="line">                data.readStrongBinder());</div><div class="line">        <span class="keyword">int</span> procState = data.readInt();</div><div class="line">        Bundle state = data.readBundle();</div><div class="line">        PersistableBundle persistentState = data.readPersistableBundle();</div><div class="line">        List&lt;ResultInfo&gt; ri = data.createTypedArrayList(ResultInfo.CREATOR);</div><div class="line">        List&lt;ReferrerIntent&gt; pi = data.createTypedArrayList(ReferrerIntent.CREATOR);</div><div class="line">        <span class="keyword">boolean</span> notResumed = data.readInt() != <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> isForward = data.readInt() != <span class="number">0</span>;</div><div class="line">        ProfilerInfo profilerInfo = data.readInt() != <span class="number">0</span></div><div class="line">                ? ProfilerInfo.CREATOR.createFromParcel(data) : <span class="keyword">null</span>;</div><div class="line">        <span class="comment">//【见流程2.20】</span></div><div class="line">        scheduleLaunchActivity(intent, b, ident, info, curConfig, overrideConfig, compatInfo,</div><div class="line">                referrer, voiceInteractor, procState, state, persistentState, ri, pi,</div><div class="line">                notResumed, isForward, profilerInfo);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-20-AT-scheduleLaunchActivity"><a href="#2-20-AT-scheduleLaunchActivity" class="headerlink" title="2.20 AT.scheduleLaunchActivity"></a>2.20 AT.scheduleLaunchActivity</h3><p>[-&gt; ApplicationThread.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">scheduleLaunchActivity</span><span class="params">(Intent intent, IBinder token, <span class="keyword">int</span> ident, ActivityInfo info, Configuration curConfig, Configuration overrideConfig, CompatibilityInfo compatInfo, String referrer, IVoiceInteractor voiceInteractor, <span class="keyword">int</span> procState, Bundle state, PersistableBundle persistentState, List&lt;ResultInfo&gt; pendingResults, List&lt;ReferrerIntent&gt; pendingNewIntents, <span class="keyword">boolean</span> notResumed, <span class="keyword">boolean</span> isForward, ProfilerInfo profilerInfo)</span> </span>&#123;</div><div class="line"></div><div class="line">     updateProcessState(procState, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">     ActivityClientRecord r = <span class="keyword">new</span> ActivityClientRecord();</div><div class="line"></div><div class="line">     r.token = token;</div><div class="line">     r.ident = ident;</div><div class="line">     r.intent = intent;</div><div class="line">     r.referrer = referrer;</div><div class="line">     r.voiceInteractor = voiceInteractor;</div><div class="line">     r.activityInfo = info;</div><div class="line">     r.compatInfo = compatInfo;</div><div class="line">     r.state = state;</div><div class="line">     r.persistentState = persistentState;</div><div class="line"></div><div class="line">     r.pendingResults = pendingResults;</div><div class="line">     r.pendingIntents = pendingNewIntents;</div><div class="line"></div><div class="line">     r.startsNotResumed = notResumed;</div><div class="line">     r.isForward = isForward;</div><div class="line"></div><div class="line">     r.profilerInfo = profilerInfo;</div><div class="line"></div><div class="line">     r.overrideConfig = overrideConfig;</div><div class="line">     updatePendingConfiguration(curConfig);</div><div class="line">     <span class="comment">//【见流程2.21】</span></div><div class="line">     sendMessage(H.LAUNCH_ACTIVITY, r);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="2-21-H-handleMessage"><a href="#2-21-H-handleMessage" class="headerlink" title="2.21 H.handleMessage"></a>2.21 H.handleMessage</h3><p>[-&gt; ActivityThread.java ::H]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</div><div class="line">    <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">        <span class="keyword">case</span> LAUNCH_ACTIVITY: &#123;</div><div class="line">            <span class="keyword">final</span> ActivityClientRecord r = (ActivityClientRecord) msg.obj;</div><div class="line">            r.packageInfo = getPackageInfoNoCheck(</div><div class="line">                    r.activityInfo.applicationInfo, r.compatInfo);</div><div class="line">            <span class="comment">//【见流程2.22】</span></div><div class="line">            handleLaunchActivity(r, <span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">break</span>;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-22-ActivityThread-handleLaunchActivity"><a href="#2-22-ActivityThread-handleLaunchActivity" class="headerlink" title="2.22 ActivityThread.handleLaunchActivity"></a>2.22 ActivityThread.handleLaunchActivity</h3><p>[-&gt; ActivityThread.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    unscheduleGcIdler();</div><div class="line">    mSomeActivitiesChanged = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">    <span class="comment">//最终回调目标Activity的onConfigurationChanged()</span></div><div class="line">    handleConfigurationChanged(<span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">//初始化wms</span></div><div class="line">    WindowManagerGlobal.initialize();</div><div class="line">    <span class="comment">//最终回调目标Activity的onCreate[见流程2.23]</span></div><div class="line">    Activity a = performLaunchActivity(r, customIntent);</div><div class="line">    <span class="keyword">if</span> (a != <span class="keyword">null</span>) &#123;</div><div class="line">        r.createdConfig = <span class="keyword">new</span> Configuration(mConfiguration);</div><div class="line">        Bundle oldState = r.state;</div><div class="line">        <span class="comment">//最终回调目标Activity的onStart,onResume.</span></div><div class="line">        handleResumeActivity(r.token, <span class="keyword">false</span>, r.isForward,</div><div class="line">                !r.activity.mFinished &amp;&amp; !r.startsNotResumed);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; r.startsNotResumed) &#123;</div><div class="line">            r.activity.mCalled = <span class="keyword">false</span>;</div><div class="line">            mInstrumentation.callActivityOnPause(r.activity);</div><div class="line">            r.paused = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">//存在error则停止该Activity</span></div><div class="line">        ActivityManagerNative.getDefault()</div><div class="line">            .finishActivity(r.token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="2-23-ActivityThread-performLaunchActivity"><a href="#2-23-ActivityThread-performLaunchActivity" class="headerlink" title="2.23 ActivityThread.performLaunchActivity"></a>2.23 ActivityThread.performLaunchActivity</h3><p>[-&gt; ActivityThread.java]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line"></div><div class="line">    ActivityInfo aInfo = r.activityInfo;</div><div class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) &#123;</div><div class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</div><div class="line">                Context.CONTEXT_INCLUDE_CODE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ComponentName component = r.intent.getComponent();</div><div class="line">    <span class="keyword">if</span> (component == <span class="keyword">null</span>) &#123;</div><div class="line">        component = r.intent.resolveActivity(</div><div class="line">            mInitialApplication.getPackageManager());</div><div class="line">        r.intent.setComponent(component);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (r.activityInfo.targetActivity != <span class="keyword">null</span>) &#123;</div><div class="line">        component = <span class="keyword">new</span> ComponentName(r.activityInfo.packageName,</div><div class="line">                r.activityInfo.targetActivity);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Activity activity = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        java.lang.ClassLoader cl = r.packageInfo.getClassLoader();</div><div class="line">        activity = mInstrumentation.newActivity(</div><div class="line">                cl, component.getClassName(), r.intent);</div><div class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</div><div class="line">        r.intent.setExtrasClassLoader(cl);</div><div class="line">        r.intent.prepareToEnterProcess();</div><div class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">            r.state.setClassLoader(cl);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">//创建Application对象</span></div><div class="line">        Application app = r.packageInfo.makeApplication(<span class="keyword">false</span>, mInstrumentation);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (activity != <span class="keyword">null</span>) &#123;</div><div class="line">            Context appContext = createBaseContextForActivity(r, activity);</div><div class="line">            CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());</div><div class="line">            Configuration config = <span class="keyword">new</span> Configuration(mCompatConfiguration);</div><div class="line"></div><div class="line">            activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                    r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                    r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                    r.referrer, r.voiceInteractor);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (customIntent != <span class="keyword">null</span>) &#123;</div><div class="line">                activity.mIntent = customIntent;</div><div class="line">            &#125;</div><div class="line">            r.lastNonConfigurationInstances = <span class="keyword">null</span>;</div><div class="line">            activity.mStartedActivity = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">int</span> theme = r.activityInfo.getThemeResource();</div><div class="line">            <span class="keyword">if</span> (theme != <span class="number">0</span>) &#123;</div><div class="line">                activity.setTheme(theme);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            activity.mCalled = <span class="keyword">false</span>;</div><div class="line">            <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mInstrumentation.callActivityOnCreate(activity, r.state);</div><div class="line">            &#125;</div><div class="line">            ...</div><div class="line">            r.activity = activity;</div><div class="line">            r.stopped = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                activity.performStart();</div><div class="line">                r.stopped = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    <span class="keyword">if</span> (r.state != <span class="keyword">null</span> || r.persistentState != <span class="keyword">null</span>) &#123;</div><div class="line">                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,</div><div class="line">                                r.persistentState);</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</div><div class="line">                    mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!r.activity.mFinished) &#123;</div><div class="line">                activity.mCalled = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">if</span> (r.isPersistable()) &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state,</div><div class="line">                            r.persistentState);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    mInstrumentation.callActivityOnPostCreate(activity, r.state);</div><div class="line">                &#125;</div><div class="line">                ...</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        r.paused = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        mActivities.put(r.token, r);</div><div class="line"></div><div class="line">    &#125;  <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>到此，正式进入了Activity的onCreate, onStart, onResume这些生命周期的过程。</p>
<h2 id="三-总结"><a href="#三-总结" class="headerlink" title="三. 总结"></a>三. 总结</h2><p>本文详细startActivity的整个启动流程，</p>
<ul>
<li>流程[<strong>2.1 ~2.4</strong>]:运行在调用者所在进程，比如从桌面启动Activity，则调用者所在进程为launcher进程，launcher进程利用ActivityManagerProxy作为Binder Client，进入system_server进程(AMS相应的Server端)。</li>
<li>流程[<strong>2.5 ~2.18</strong>]:运行在system_server系统进程，整个过程最为复杂、核心的过程，下面其中部分步骤：流程[2.7]：会调用到resolveActivity()，借助PackageManager来查询系统中所有符合要求的Activity，当存在多个满足条件的Activity则会弹框让用户来选择;流程[2.8]：创建ActivityRecord对象，并检查是否运行App切换，然后再处理mPendingActivityLaunches中的activity;流程[2.9]：为Activity找到或创建新的Task对象，设置flags信息；流程[2.13]：当没有处于非finishing状态的Activity，则直接回到桌面； 否则，当mResumedActivity不为空则执行<code>startPausingLocked</code>()暂停该activity;然后再进入<code>startSpecificActivityLocked</code>()环节;流程[2.14]：当目标进程已存在则直接进入流程[2.17]，当进程不存在则创建进程，经过层层调用还是会进入流程[2.17];流程[2.17]：system_server进程利用的ATP(Binder Client)，经过Binder，程序接下来进入目标进程。</li>
<li>流程[<strong>2.19 ~2.18</strong>]:运行在目标进程，通过Handler消息机制，该进程中的Binder线程向主线程发送<code>H.LAUNCH_ACTIVITY</code>，最终会通过反射创建目标Activity，然后进入onCreate()生命周期。</li>
</ul>
<p>从另一个角度下图来概括：</p>
<p><img src="http://gityuan.com/images/activity/start_activity_process.jpg" alt="start_activity_process"></p>
<p>启动流程：</p>
<ol>
<li>点击桌面App图标，Launcher进程采用Binder IPC向system_server进程发起startActivity请求；</li>
<li>system_server进程接收到请求后，向zygote进程发送创建进程的请求；</li>
<li>Zygote进程fork出新的子进程，即App进程；</li>
<li>App进程，通过Binder IPC向sytem_server进程发起attachApplication请求；</li>
<li>system_server进程在收到请求后，进行一系列准备工作后，再通过binder IPC向App进程发送scheduleLaunchActivity请求；</li>
<li>App进程的binder线程（ApplicationThread）在收到请求后，通过handler向主线程发送LAUNCH_ACTIVITY消息；</li>
<li>主线程在收到Message后，通过发射机制创建目标Activity，并回调Activity.onCreate()等方法。</li>
</ol>
<p>到此，App便正式启动，开始进入Activity生命周期，执行完onCreate/onStart/onResume方法，UI渲染结束后便可以看到App的主界面。 启动Activity较为复杂，后续计划再进一步讲解生命周期过程与系统是如何交互，以及UI渲染过程，敬请期待。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ActivityThread/" rel="tag"># ActivityThread</a>
          
            <a href="/tags/AMS/" rel="tag"># AMS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/13/Android的消息机制/" rel="next" title="Android的消息机制">
                <i class="fa fa-chevron-left"></i> Android的消息机制
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/03/15/Android的线程和线程池/" rel="prev" title="Android的线程和线程池">
                Android的线程和线程池 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="jarkeet" />
            
              <p class="site-author-name" itemprop="name">jarkeet</p>
              <p class="site-description motion-element" itemprop="description">闲来无事写写字</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">42</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/jarkeet" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-概述"><span class="nav-number">1.</span> <span class="nav-text">一. 概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-启动流程"><span class="nav-number">2.</span> <span class="nav-text">二. 启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Activity-startActivity"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Activity.startActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-startActivityForResult"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 startActivityForResult</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-execStartActivity"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 execStartActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-AMP-startActivity"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 AMP.startActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-AMN-onTransact"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 AMN.onTransact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-6-AMS-startActivity"><span class="nav-number">2.6.</span> <span class="nav-text">2.6 AMS.startActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-7-ASS-startActivityMayWait"><span class="nav-number">2.7.</span> <span class="nav-text">2.7 ASS.startActivityMayWait</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-1-ASS-resolveActivity"><span class="nav-number">2.7.1.</span> <span class="nav-text">2.7.1 ASS.resolveActivity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-2-PKMS-resolveIntent"><span class="nav-number">2.7.2.</span> <span class="nav-text">2.7.2 PKMS.resolveIntent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-7-3-PMS-queryIntentActivities"><span class="nav-number">2.7.3.</span> <span class="nav-text">2.7.3 PMS.queryIntentActivities</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-8-ASS-startActivityLocked"><span class="nav-number">2.8.</span> <span class="nav-text">2.8 ASS.startActivityLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-1-AMS-checkAppSwitchAllowedLocked"><span class="nav-number">2.8.1.</span> <span class="nav-text">2.8.1 AMS.checkAppSwitchAllowedLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-8-2-ASS-doPendingActivityLaunchesLocked"><span class="nav-number">2.8.2.</span> <span class="nav-text">2.8.2 ASS.doPendingActivityLaunchesLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-9-ASS-startActivityUncheckedLocked"><span class="nav-number">2.9.</span> <span class="nav-text">2.9 ASS.startActivityUncheckedLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-9-1-Launch-Mode"><span class="nav-number">2.9.1.</span> <span class="nav-text">2.9.1 Launch Mode</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-10-AS-startActivityLocked"><span class="nav-number">2.10.</span> <span class="nav-text">2.10 AS.startActivityLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-11-ASS-resumeTopActivitiesLocked"><span class="nav-number">2.11.</span> <span class="nav-text">2.11 ASS.resumeTopActivitiesLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-12-AS-resumeTopActivityLocked"><span class="nav-number">2.12.</span> <span class="nav-text">2.12 AS.resumeTopActivityLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-13-AS-resumeTopActivityInnerLocked"><span class="nav-number">2.13.</span> <span class="nav-text">2.13 AS.resumeTopActivityInnerLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-13-1-ASS-pauseBackStacks"><span class="nav-number">2.13.1.</span> <span class="nav-text">2.13.1 ASS.pauseBackStacks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-13-2-AS-startPausingLocked"><span class="nav-number">2.13.2.</span> <span class="nav-text">2.13.2 AS.startPausingLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-13-3-completePauseLocked"><span class="nav-number">2.13.3.</span> <span class="nav-text">3.13.3 completePauseLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-14-ASS-startSpecificActivityLocked"><span class="nav-number">2.14.</span> <span class="nav-text">2.14 ASS.startSpecificActivityLocked</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-15-AMS-startProcessLocked"><span class="nav-number">2.14.1.</span> <span class="nav-text">2.15 AMS.startProcessLocked</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-16-ASS-attachApplicationLocked"><span class="nav-number">2.14.2.</span> <span class="nav-text">2.16 ASS.attachApplicationLocked</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-17-ASS-realStartActivityLocked"><span class="nav-number">2.15.</span> <span class="nav-text">2.17 ASS.realStartActivityLocked</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-18-ATP-scheduleLaunchActivity"><span class="nav-number">2.16.</span> <span class="nav-text">2.18 ATP.scheduleLaunchActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-19-ATN-onTransact"><span class="nav-number">2.17.</span> <span class="nav-text">2.19 ATN.onTransact</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-20-AT-scheduleLaunchActivity"><span class="nav-number">2.18.</span> <span class="nav-text">2.20 AT.scheduleLaunchActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-21-H-handleMessage"><span class="nav-number">2.19.</span> <span class="nav-text">2.21 H.handleMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-22-ActivityThread-handleLaunchActivity"><span class="nav-number">2.20.</span> <span class="nav-text">2.22 ActivityThread.handleLaunchActivity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-23-ActivityThread-performLaunchActivity"><span class="nav-number">2.21.</span> <span class="nav-text">2.23 ActivityThread.performLaunchActivity</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-总结"><span class="nav-number">3.</span> <span class="nav-text">三. 总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">jarkeet</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
